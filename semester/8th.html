<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>8th Semester - Academic Resort</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="../favicon.svg" />
    <link rel="stylesheet" href="../assets/styles.css" />
    <script src="../assets/api-keys.js"></script>
    <script src="../assets/batch-loader.js"></script>
    <script src="../assets/script.js" defer></script>
  </head>
  <body>
    <div data-include="../assets/header.html"></div>
    <!-- App Header -->
    <header class="app-header">
      <h1>Academic Resort</h1>
    </header>
    <main class="container">
      <div class="page-intro">
        <h1 class="page-title">8th Semester - Advanced Foundation</h1>
        <p>
          <b>
            Explore comprehensive resources for all 8th Semester courses. Each
            subject has its own dedicated page with organized materials,
            question banks, and teacher-specific resources.
          </b>
        </p>

        <!-- Subject Cards -->
        <div class="subjects-grid">
          <a
            href="../courses/4201-accounting-theory.html"
            class="subject-card"
          >
            <span class="subject-code">4201</span>
            <h3>Accounting Theory</h3>
          </a>

          <a
            href="../courses/4202-business-analysis-and-valuation.html"
            class="subject-card"
          >
            <span class="subject-code">4202</span>
            <h3>Business Analysis and Valuation</h3>
          </a>

          <a
            href="../courses/4203-data-analytics.html"
            class="subject-card"
          >
            <span class="subject-code">4203</span>
            <h3>Data Analytics</h3>
          </a>

          <a
            href="../courses/4204-strategic-management.html"
            class="subject-card"
          >
            <span class="subject-code">4204</span>
            <h3>Strategic Management</h3>
          </a>

          <a
            href="../courses/4205-research-methodology.html"
            class="subject-card"
          >
            <span class="subject-code">4205</span>
            <h3>Research Methodology</h3>
          </a>

        </div>
            

        <!-- Traditional Table of Contents for Batch Archives -->

        <!-- Traditional Table of Contents for Batch Archives -->
        <div class="toc-accordion">
          <div class="toc-header" onclick="toggleTOC()">
            <h4 class="font-weight-semibold">Batch Archives</h4>
            <span class="toc-toggle" id="toc-toggle">▼</span>
          </div>
          <ul class="small toc-content" id="table-of-contents">
            <!-- Will be populated dynamically -->
          </ul>
        </div>
      </div>

      <!-- Simple batch list -->
      <div id="batches-container">
        <section class="drive-batch-container" id="batch-29">
          <div class="card drive-embed-card">
            <div class="batch-header">
              <h2>29th Batch</h2>
              <button
                class="root-folder-btn"
                id="root-btn-29"
                title="Open root folder"
              >
                ↗
              </button>
            </div>
            <div class="drive-list-wrapper">
              <div class="drive-spinner" id="spinner-29"></div>
              <ul id="drive-list-29" class="drive-list"></ul>
            </div>
          </div>
        </section>

        <section class="drive-batch-container" id="batch-28">
          <div class="card drive-embed-card">
            <div class="batch-header">
              <h2>28th Batch</h2>
              <button
                class="root-folder-btn"
                id="root-btn-28"
                title="Open root folder"
              >
                ↗
              </button>
            </div>
            <div class="drive-list-wrapper">
              <div class="drive-spinner" id="spinner-28"></div>
              <ul id="drive-list-28" class="drive-list"></ul>
            </div>
          </div>
        </section>

        <section class="drive-batch-container" id="batch-27">
          <div class="card drive-embed-card">
            <div class="batch-header">
              <h2>27th Batch</h2>
              <button
                class="root-folder-btn"
                id="root-btn-27"
                title="Open root folder"
              >
                ↗
              </button>
            </div>
            <div class="drive-list-wrapper">
              <div class="drive-spinner" id="spinner-27"></div>
              <ul id="drive-list-27" class="drive-list"></ul>
            </div>
          </div>
        </section>

        <section class="drive-batch-container" id="batch-26">
          <div class="card drive-embed-card">
            <div class="batch-header">
              <h2>26th Batch</h2>
              <button
                class="root-folder-btn"
                id="root-btn-26"
                title="Open root folder"
              >
                ↗
              </button>
            </div>
            <div class="drive-list-wrapper">
              <div class="drive-spinner" id="spinner-26"></div>
              <ul id="drive-list-26" class="drive-list"></ul>
            </div>
          </div>
        </section>
      </div>
    </main>

    <div data-include="../assets/footer.html"></div>

    <script>
      // Batch folders - loaded from JSON
      let batches = {};

      // API key restricted to jabir-a-h.github.io domain in Google Cloud Console
      // API keys are now loaded from api-keys.js for centralized management
      // Use getNextApiKey() to get API keys with automatic rotation

      // === PERSISTENT CACHE SYSTEM (24-hour localStorage) ===

      // Cache configuration
      const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
      const CACHE_VERSION = "v1"; // Increment this to force cache refresh on updates

      // Get cache key for a folder
      function getCacheKey(folderId, depth = 0) {
        return `driveCache_8th_${CACHE_VERSION}_${folderId}_${depth}`;
      }

      // Get global cache metadata key
      function getGlobalCacheKey() {
        return `driveCacheMetadata_8th_${CACHE_VERSION}`;
      }

      // Save data to persistent cache with timestamp
      function saveToPersistentCache(folderId, data, depth = 0) {
        try {
          const cacheKey = getCacheKey(folderId, depth);
          const cacheData = {
            data: data,
            timestamp: Date.now(),
            version: CACHE_VERSION,
          };
          localStorage.setItem(cacheKey, JSON.stringify(cacheData));

          // Update metadata
          updateCacheMetadata(cacheKey);
        } catch (error) {
          console.warn("Failed to save to persistent cache:", error);
        }
      }

      // Load data from persistent cache
      function loadFromPersistentCache(folderId, depth = 0) {
        try {
          const cacheKey = getCacheKey(folderId, depth);
          const cached = localStorage.getItem(cacheKey);

          if (!cached) return null;

          const cacheData = JSON.parse(cached);
          const age = Date.now() - cacheData.timestamp;

          // Check if cache is expired or version mismatch
          if (age > CACHE_DURATION || cacheData.version !== CACHE_VERSION) {
            localStorage.removeItem(cacheKey);
            removeCacheFromMetadata(cacheKey);
            return null;
          }

          return cacheData.data;
        } catch (error) {
          console.warn("Failed to load from persistent cache:", error);
          return null;
        }
      }

      // Update cache metadata for cleanup
      function updateCacheMetadata(cacheKey) {
        try {
          const metaKey = getGlobalCacheKey();
          let metadata = JSON.parse(
            localStorage.getItem(metaKey) || '{"keys":[],"lastCleanup":0}'
          );

          if (!metadata.keys.includes(cacheKey)) {
            metadata.keys.push(cacheKey);
          }
          metadata.lastUpdated = Date.now();

          localStorage.setItem(metaKey, JSON.stringify(metadata));
        } catch (error) {
          console.warn("Failed to update cache metadata:", error);
        }
      }

      // Remove cache key from metadata
      function removeCacheFromMetadata(cacheKey) {
        try {
          const metaKey = getGlobalCacheKey();
          let metadata = JSON.parse(
            localStorage.getItem(metaKey) || '{"keys":[],"lastCleanup":0}'
          );
          metadata.keys = metadata.keys.filter((key) => key !== cacheKey);
          localStorage.setItem(metaKey, JSON.stringify(metadata));
        } catch (error) {
          console.warn("Failed to remove from cache metadata:", error);
        }
      }

      // Global memory cache for faster subsequent access
      let memoryCache = new Map();

      // === DRIVE API FUNCTIONS ===

      // Toggle TOC functionality
      function toggleTOC() {
        const content = document.getElementById("table-of-contents");
        const toggle = document.getElementById("toc-toggle");

        if (content.style.display === "none" || !content.style.display) {
          content.style.display = "block";
          toggle.textContent = "▲";
        } else {
          content.style.display = "none";
          toggle.textContent = "▼";
        }
      }

      // Initialize when DOM is loaded
      document.addEventListener("DOMContentLoaded", async function () {
        console.log("Loading 8th semester resources...");

        try {
          // Load drive mapping configuration
          // Use the batch loader utility to get drive folder mapping
          const mapping = await getDriveFolderMapping();
          // Extract batches for current semester {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          
          console.log("Drive mapping loaded:", mapping);

          // Extract 8th semester data
          if (mapping["8th"] && mapping["8th"].batches) {
            batches = mapping["8th"].batches;
            console.log("8th semester batches:", batches);

            // Build table of contents
            buildTableOfContents();

            // Start loading batches with controlled concurrency
            await loadAllBatches();
          } else {
            console.error("No 8th semester data found in mapping");
            showError("Configuration not found for 8th semester");
          }
        } catch (error) {
          console.error("Error loading batch mapping:", error);
          showError(`Failed to load configuration: ${error.message}`);
        }
      });

      function buildTableOfContents() {
        const toc = document.getElementById("table-of-contents");
        if (!toc) return;

        toc.innerHTML = "";

        Object.entries(batches).forEach(([batchNumber, batchData]) => {
          const li = document.createElement("li");
          li.innerHTML = `<a href="#batch-${batchNumber}" onclick="scrollToBatch('${batchNumber}')">${batchData.label || `${batchNumber} Batch`}</a>`;
          toc.appendChild(li);
        });
      }

      function scrollToBatch(batchNumber) {
        const element = document.getElementById(`batch-${batchNumber}`);
        if (element) {
          element.scrollIntoView({ behavior: "smooth" });
        }
      }

      async function loadAllBatches() {
        const batchEntries = Object.entries(batches);
        console.log(`Starting to load ${batchEntries.length} batches...`);

        // Load batches with controlled concurrency
        for (const [batchNumber, batchData] of batchEntries) {
          try {
            await loadBatchContent(batchNumber, batchData.folderId);
            // Small delay to prevent overwhelming the API
            await new Promise((resolve) => setTimeout(resolve, 100));
          } catch (error) {
            console.error(`Error loading batch ${batchNumber}:`, error);
          }
        }

        console.log("All batches loading initiated");
      }

      async function loadBatchContent(batchNumber, folderId) {
        const listContainer = document.getElementById(`drive-list-${batchNumber}`);
        const spinner = document.getElementById(`spinner-${batchNumber}`);
        const rootBtn = document.getElementById(`root-btn-${batchNumber}`);

        if (!listContainer) {
          console.warn(`Container not found for batch ${batchNumber}`);
          return;
        }

        // Set up root folder button
        if (rootBtn && folderId) {
          rootBtn.onclick = () =>
            window.open(`https://drive.google.com/drive/folders/${folderId}`, "_blank");
        }

        try {
          // Check persistent cache first
          const cachedData = loadFromPersistentCache(folderId);
          if (cachedData) {
            console.log(`Loading batch ${batchNumber} from cache`);
            listContainer.innerHTML = cachedData;
            if (spinner) spinner.style.display = "none";
            return;
          }

          // Show loading spinner
          if (spinner) {
            spinner.style.display = "block";
            spinner.innerHTML = "🔄 Loading...";
          }

          console.log(`Fetching batch ${batchNumber} from API...`);

          // Fetch from Google Drive API
          const apiUrl = `https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents&key=${getNextApiKey()}&fields=files(id,name,mimeType,webViewLink,size,modifiedTime)&pageSize=1000`;

          const response = await fetch(apiUrl);

          // Extract batches for current semester {
            throw new Error(`API request failed: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();
          console.log(`Batch ${batchNumber} API response:`, data);

          if (!data.files || data.files.length === 0) {
            const emptyMessage = '<li class="drive-item"><span class="item-name">No files found in this batch</span></li>';
            listContainer.innerHTML = emptyMessage;
            saveToPersistentCache(folderId, emptyMessage);
          } else {
            // Sort files: folders first, then by name
            const sortedFiles = data.files.sort((a, b) => {
              const aIsFolder = a.mimeType === "application/vnd.google-apps.folder";
              const bIsFolder = b.mimeType === "application/vnd.google-apps.folder";

              if (aIsFolder && !bIsFolder) return -1;
              if (!aIsFolder && bIsFolder) return 1;
              return a.name.localeCompare(b.name);
            });

            // Create HTML for files
            const html = sortedFiles
              .map((file) => {
                const isFolder = file.mimeType === "application/vnd.google-apps.folder";
                const icon = isFolder ? "📁" : getFileIcon(file.mimeType);
                const sizeText = file.size && !isFolder ? formatFileSize(file.size) : "";

                return `
                  <li class="drive-item ${isFolder ? "folder" : "file"}">
                    <a href="${file.webViewLink}" target="_blank" class="item-link">
                      <span class="item-icon">${icon}</span>
                      <span class="item-name">${file.name}</span>
                      ${sizeText ? `<span class="item-size">${sizeText}</span>` : ""}
                    </a>
                  </li>
                `;
              })
              .join("");

            listContainer.innerHTML = html;

            // Cache the result
            saveToPersistentCache(folderId, html);
          }
        } catch (error) {
          console.error(`Error loading batch ${batchNumber}:`, error);
          const errorMessage = `<li class="drive-item error"><span class="item-name">Error loading files: ${error.message}</span></li>`;
          listContainer.innerHTML = errorMessage;
        } finally {
          // Hide spinner
          if (spinner) {
            spinner.style.display = "none";
          }
        }
      }

      function getFileIcon(mimeType) {
        const iconMap = {
          "application/pdf": "📄",
          "application/vnd.google-apps.document": "📝",
          "application/vnd.google-apps.spreadsheet": "📊",
          "application/vnd.google-apps.presentation": "📽️",
          "application/vnd.openxmlformats-officedocument.wordprocessingml.document": "📝",
          "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet": "📊",
          "application/vnd.openxmlformats-officedocument.presentationml.presentation": "📽️",
          "image/jpeg": "🖼️",
          "image/png": "🖼️",
          "image/gif": "🖼️",
          "video/mp4": "🎥",
          "video/mpeg": "🎥",
          "audio/mpeg": "🎵",
          "audio/wav": "🎵",
          "text/plain": "📄",
          "application/zip": "🗜️",
          "application/x-zip-compressed": "🗜️",
        };

        return iconMap[mimeType] || "📄";
      }

      function formatFileSize(bytes) {
        if (!bytes) return "";
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + " " + sizes[i];
      }

      function showError(message) {
        console.error(message);
        const containers = document.querySelectorAll('[id^="drive-list-"]');
        containers.forEach((container) => {
          container.innerHTML = `<li class="drive-item error"><span class="item-name">${message}</span></li>`;
        });

        // Hide all spinners
        const spinners = document.querySelectorAll('[id^="spinner-"]');
        spinners.forEach((spinner) => {
          spinner.style.display = "none";
        });
      }
    </script>
  </body>
</html>
