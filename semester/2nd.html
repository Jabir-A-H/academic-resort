<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>2nd Semester - Academic Resort</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="../favicon.svg" />
    <link rel="stylesheet" href="../assets/styles.css" />
    <script src="../assets/api-keys.js"></script>
    <script src="../assets/batch-loader.js"></script>
    <script src="../assets/script.js" defer></script>
  </head>
  <body>
    <div data-include="../assets/header.html"></div>
    <!-- App Header -->
    <header class="app-header">
      <h1>Academic Resort</h1>
    </header>
    <main class="container">
      <div class="page-intro">
        <h1 class="page-title">2nd Semester - Building Foundations</h1>
        <p>
          <b>
            Explore comprehensive resources for all 2nd Semester courses. Each
            subject has its own dedicated page with organized materials,
            question banks, and teacher-specific resources.
          </b>
        </p>

        <!-- Subject Cards -->
        <div class="subjects-grid">
          <a
            href="../courses/1201-intermediate-accounting.html"
            class="subject-card"
          >
            <div class="subject-header">
              <span class="subject-code">1201</span>
              <span class="subject-icon">üìÑ</span>
            </div>
            <h3>Intermediate Accounting</h3>
            <p>
              Advanced accounting principles, financial reporting, and complex
              transactions
            </p>
            <div class="subject-meta">
              <span class="resource-count">55+ Resources</span>
              <span class="question-count">35+ Questions</span>
            </div>
          </a>

          <a href="../courses/1202-microeconomics.html" class="subject-card">
            <div class="subject-header">
              <span class="subject-code">1202</span>
              <span class="subject-icon">üìà</span>
            </div>
            <h3>Microeconomics</h3>
            <p>
              Consumer behavior, market structures, and economic decision-making
              principles
            </p>
            <div class="subject-meta">
              <span class="resource-count">45+ Resources</span>
              <span class="question-count">30+ Questions</span>
            </div>
          </a>

          <a
            href="../courses/1203-management-organizational-behavior.html"
            class="subject-card"
          >
            <div class="subject-header">
              <span class="subject-code">1203</span>
              <span class="subject-icon">üë§</span>
            </div>
            <h3>Management & Organizational Behavior</h3>
            <p>
              Leadership principles, team dynamics, and organizational
              management strategies
            </p>
            <div class="subject-meta">
              <span class="resource-count">40+ Resources</span>
              <span class="question-count">28+ Questions</span>
            </div>
          </a>

          <a
            href="../courses/1204-business-mathematics-ii.html"
            class="subject-card"
          >
            <div class="subject-header">
              <span class="subject-code">1204</span>
              <span class="subject-icon">üìä</span>
            </div>
            <h3>Mathematics for Business Decisions-II</h3>
            <p>
              Advanced mathematical concepts, calculus, and statistical
              applications
            </p>
            <div class="subject-meta">
              <span class="resource-count">50+ Resources</span>
              <span class="question-count">45+ Questions</span>
            </div>
          </a>

          <a href="../courses/1205-bangladesh-studies.html" class="subject-card">
            <div class="subject-header">
              <span class="subject-code">1205</span>
              <span class="subject-icon">üèõÔ∏è</span>
            </div>
            <h3>Bangladesh Studies</h3>
            <p>
              History, culture, politics, and socio-economic development of
              Bangladesh
            </p>
            <div class="subject-meta">
              <span class="resource-count">35+ Resources</span>
              <span class="question-count">25+ Questions</span>
            </div>
          </a>
        </div>

        <!-- Quick Navigation -->
        <div class="quick-nav">
          <h3>Quick Access</h3>
          <div class="nav-buttons">
            <a href="course-teachers.html?semester=2nd" class="nav-btn">
              <span class="icon">üë©‚Äçüè´</span>
              View All Teachers
            </a>
            <a href="browse.html?semester=2nd" class="nav-btn">
              <span class="icon">üîç</span>
              Browse All Resources
            </a>
          </div>
        </div>

        <!-- Traditional Table of Contents for Batch Archives -->
        <div class="toc-accordion">
          <div class="toc-header" onclick="toggleTOC()">
            <h4 class="font-weight-semibold">Batch Archives</h4>
            <span class="toc-toggle" id="toc-toggle">‚ñº</span>
          </div>
          <ul class="small toc-content" id="table-of-contents">
            <!-- Will be populated dynamically -->
          </ul>
        </div>
      </div>

      <!-- Simple batch list -->
      <div id="batches-container">
        <section class="drive-batch-container" id="batch-30">
          <div class="card drive-embed-card">
            <div class="batch-header">
              <h2>30th Batch</h2>
              <button
                class="root-folder-btn"
                onclick="window.open('https://drive.google.com/drive/folders/1qQs3-YK5TDBkWNOIwS5fj113TB5h1tPu', '_blank')"
                title="Open root folder"
              >
                ‚Üó
              </button>
            </div>
            <div class="drive-list-wrapper">
              <div class="drive-spinner" id="spinner-30"></div>
              <ul id="drive-list-30" class="drive-list"></ul>
            </div>
          </div>
        </section>

        <section class="drive-batch-container" id="batch-29">
          <div class="card drive-embed-card">
            <div class="batch-header">
              <h2>29th Batch</h2>
              <button
                class="root-folder-btn"
                onclick="window.open('https://drive.google.com/drive/folders/1uAP0SsHed-KFZmHWP2Kvr-8VSa2nEja8', '_blank')"
                title="Open root folder"
              >
                ‚Üó
              </button>
            </div>
            <div class="drive-list-wrapper">
              <div class="drive-spinner" id="spinner-29"></div>
              <ul id="drive-list-29" class="drive-list"></ul>
            </div>
          </div>
        </section>

        <section class="drive-batch-container" id="batch-28">
          <div class="card drive-embed-card">
            <div class="batch-header">
              <h2>28th Batch</h2>
              <button
                class="root-folder-btn"
                id="root-btn-28"
                title="Open root folder"
              >
                ‚Üó
              </button>
            </div>
            <div class="drive-list-wrapper">
              <div class="drive-spinner" id="spinner-28"></div>
              <ul id="drive-list-28" class="drive-list"></ul>
            </div>
          </div>
        </section>

        <section class="drive-batch-container" id="batch-27">
          <div class="card drive-embed-card">
            <div class="batch-header">
              <h2>27th Batch</h2>
              <button
                class="root-folder-btn"
                id="root-btn-27"
                title="Open root folder"
              >
                ‚Üó
              </button>
            </div>
            <div class="drive-list-wrapper">
              <div class="drive-spinner" id="spinner-27"></div>
              <ul id="drive-list-27" class="drive-list"></ul>
            </div>
          </div>
        </section>

        <section class="drive-batch-container" id="batch-books">
          <div class="card drive-embed-card">
            <div class="batch-header">
              <h2>Books & Slides</h2>
              <button
                class="root-folder-btn"
                id="root-btn-books"
                title="Open root folder"
              >
                ‚Üó
              </button>
            </div>
            <div class="drive-list-wrapper">
              <div class="drive-spinner" id="spinner-books"></div>
              <ul id="drive-list-books" class="drive-list"></ul>
            </div>
          </div>
        </section>

        <section class="drive-batch-container" id="batch-math">
          <div class="card drive-embed-card">
            <div class="batch-header">
              <h2>Math II Notes</h2>
              <button
                class="root-folder-btn"
                id="root-btn-math"
                title="Open root folder"
              >
                ‚Üó
              </button>
            </div>
            <div class="drive-list-wrapper">
              <div class="drive-spinner" id="spinner-math"></div>
              <ul id="drive-list-math" class="drive-list"></ul>
            </div>
          </div>
        </section>

        <section class="drive-batch-container" id="batch-personal">
          <div class="card drive-embed-card">
            <div class="batch-header">
              <h2>Personal Notes</h2>
              <button
                class="root-folder-btn"
                id="root-btn-personal"
                title="Open root folder"
              >
                ‚Üó
              </button>
            </div>
            <div class="drive-list-wrapper">
              <div class="drive-spinner" id="spinner-personal"></div>
              <ul id="drive-list-personal" class="drive-list"></ul>
            </div>
          </div>
        </section>

        <section class="drive-batch-container" id="batch-syllabus">
          <div class="card drive-embed-card">
            <div class="batch-header">
              <h2>Syllabus</h2>
              <button
                class="root-folder-btn"
                id="root-btn-syllabus"
                title="Open root folder"
              >
                ‚Üó
              </button>
            </div>
            <div class="drive-list-wrapper">
              <div class="drive-spinner" id="spinner-syllabus"></div>
              <ul id="drive-list-syllabus" class="drive-list"></ul>
            </div>
          </div>
        </section>
      </div>
    </main>
    <div data-include="../assets/footer.html"></div>

    <script>
      // Batch folders - loaded from JSON
      let batches = {};

      // API key restricted to jabir-a-h.github.io domain in Google Cloud Console
      // API keys are now loaded from api-keys.js for centralized management
      // Use getNextApiKey() to get API keys with automatic rotation

      // === PERSISTENT CACHE SYSTEM (24-hour localStorage) ===

      // Cache configuration
      const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
      const CACHE_VERSION = "v1"; // Increment this to force cache refresh on updates

      // Get cache key for a folder
      function getCacheKey(folderId, depth = 0) {
        return `driveCache_2nd_${CACHE_VERSION}_${folderId}_${depth}`;
      }

      // Get global cache metadata key
      function getGlobalCacheKey() {
        return `driveCacheMetadata_2nd_${CACHE_VERSION}`;
      }

      // Save data to persistent cache with timestamp
      function saveToPersistentCache(folderId, data, depth = 0) {
        try {
          const cacheKey = getCacheKey(folderId, depth);
          const cacheData = {
            data: data,
            timestamp: Date.now(),
            version: CACHE_VERSION,
          };
          localStorage.setItem(cacheKey, JSON.stringify(cacheData));

          // Update metadata
          updateCacheMetadata(cacheKey);
        } catch (error) {
          console.warn("Failed to save to persistent cache:", error);
        }
      }

      // Load data from persistent cache
      function loadFromPersistentCache(folderId, depth = 0) {
        try {
          const cacheKey = getCacheKey(folderId, depth);
          const cached = localStorage.getItem(cacheKey);

          if (!cached) return null;

          const cacheData = JSON.parse(cached);
          const age = Date.now() - cacheData.timestamp;

          // Check if cache is expired or version mismatch
          if (age > CACHE_DURATION || cacheData.version !== CACHE_VERSION) {
            localStorage.removeItem(cacheKey);
            removeCacheFromMetadata(cacheKey);
            return null;
          }

          return cacheData.data;
        } catch (error) {
          console.warn("Failed to load from persistent cache:", error);
          return null;
        }
      }

      // Update cache metadata for cleanup
      function updateCacheMetadata(cacheKey) {
        try {
          const metaKey = getGlobalCacheKey();
          let metadata = JSON.parse(
            localStorage.getItem(metaKey) || '{"keys":[],"lastCleanup":0}'
          );

          if (!metadata.keys.includes(cacheKey)) {
            metadata.keys.push(cacheKey);
          }
          metadata.lastUpdated = Date.now();

          localStorage.setItem(metaKey, JSON.stringify(metadata));
        } catch (error) {
          console.warn("Failed to update cache metadata:", error);
        }
      }

      // Remove cache key from metadata
      function removeCacheFromMetadata(cacheKey) {
        try {
          const metaKey = getGlobalCacheKey();
          let metadata = JSON.parse(
            localStorage.getItem(metaKey) || '{"keys":[],"lastCleanup":0}'
          );
          metadata.keys = metadata.keys.filter((key) => key !== cacheKey);
          localStorage.setItem(metaKey, JSON.stringify(metadata));
        } catch (error) {
          console.warn("Failed to remove from cache metadata:", error);
        }
      }

      // Clean expired cache entries
      function cleanExpiredCache() {
        try {
          const metaKey = getGlobalCacheKey();
          let metadata = JSON.parse(
            localStorage.getItem(metaKey) || '{"keys":[],"lastCleanup":0}'
          );

          // Only run cleanup once per hour
          if (Date.now() - metadata.lastCleanup < 60 * 60 * 1000) return;

          const validKeys = [];

          metadata.keys.forEach((cacheKey) => {
            try {
              const cached = localStorage.getItem(cacheKey);
              if (cached) {
                const cacheData = JSON.parse(cached);
                const age = Date.now() - cacheData.timestamp;

                if (
                  age <= CACHE_DURATION &&
                  cacheData.version === CACHE_VERSION
                ) {
                  validKeys.push(cacheKey);
                } else {
                  localStorage.removeItem(cacheKey);
                }
              }
            } catch (error) {
              // Remove invalid cache entries
              localStorage.removeItem(cacheKey);
            }
          });

          metadata.keys = validKeys;
          metadata.lastCleanup = Date.now();
          localStorage.setItem(metaKey, JSON.stringify(metadata));
        } catch (error) {
          console.warn("Cache cleanup failed:", error);
        }
      }

      // Get cache statistics
      function getCacheStats() {
        try {
          const metaKey = getGlobalCacheKey();
          const metadata = JSON.parse(
            localStorage.getItem(metaKey) || '{"keys":[],"lastCleanup":0}'
          );

          let totalSize = 0;
          let validEntries = 0;

          metadata.keys.forEach((cacheKey) => {
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
              totalSize += cached.length;
              validEntries++;
            }
          });

          return {
            entries: validEntries,
            sizeKB: Math.round(totalSize / 1024),
            lastUpdated: metadata.lastUpdated
              ? new Date(metadata.lastUpdated).toLocaleString()
              : "Never",
          };
        } catch (error) {
          return { entries: 0, sizeKB: 0, lastUpdated: "Error" };
        }
      }

      // Clear all cache data (useful for debugging or forcing refresh)
      function clearAllCache() {
        try {
          const metaKey = getGlobalCacheKey();
          const metadata = JSON.parse(
            localStorage.getItem(metaKey) || '{"keys":[],"lastCleanup":0}'
          );

          // Remove all cache entries
          metadata.keys.forEach((cacheKey) => {
            localStorage.removeItem(cacheKey);
          });

          // Clear metadata
          localStorage.removeItem(metaKey);

          console.log("üóëÔ∏è All 2nd semester cache data cleared");
          return true;
        } catch (error) {
          console.error("Failed to clear cache:", error);
          return false;
        }
      }

      // Make cache management functions available globally for debugging
      window.secondSemesterCache = {
        stats: getCacheStats,
        clear: clearAllCache,
        cleanup: cleanExpiredCache,
      };

      // === END CACHE SYSTEM ===

      // Load mapping from batch JSON files
      async function loadBatchMapping() {
        try {
          // Use the batch loader utility to get drive folder mapping for 2nd semester
          const mapping = await getDriveFolderMapping();
          
          // Extract 2nd semester batches
          if (mapping["2nd"]) {
            Object.entries(mapping["2nd"]).forEach(
              ([batchKey, batchData]) => {
                batches[batchKey] = batchData.folderId;
              }
            );
          }

          return batches;
        } catch (error) {
          console.error("Error loading batch mapping:", error);
          // Fallback to basic structure if batch loading fails
          batches = {
            30: "1qQs3-YK5TDBkWNOIwS5fj113TB5h1tPu",
            29: "1uAP0SsHed-KFZmHWP2Kvr-8VSa2nEja8",
            28: "1PSQngE3zPIOhrct_iZfwjMhUpSgKPonj",
            27: "17Wd_QVFQyb4V-eY-GvzmSOCt2Dywcb7_",
            books: "1TPB_qo0BhrUTjSj5Vv92wap73MaTb9IU",
            math: "10Xl4jThcLbNF_5Iq2-9-zL9gxZKF8tlx",
            personal: "1GqE1mLi-ir3OCvBdMBgChCIpws8dTGI7",
            syllabus: "1WkOJq5ep_6p3YZw3tENrH6wbAOWdWrjI",
          };
          return batches;
        }
      }

      // Toggle Table of Contents accordion
      function toggleTOC() {
        const tocContent = document.getElementById("table-of-contents");
        const tocToggle = document.getElementById("toc-toggle");

        if (tocContent.style.display === "none") {
          tocContent.style.display = "block";
          tocToggle.textContent = "‚ñ≤";
        } else {
          tocContent.style.display = "none";
          tocToggle.textContent = "‚ñº";
        }
      }

      // Load Drive folder contents
      async function loadBatch(batchKey, folderId) {
        const spinner = document.getElementById(`spinner-${batchKey}`);
        const list = document.getElementById(`drive-list-${batchKey}`);

        spinner.style.display = "block";

        // Check persistent cache first (24-hour localStorage)
        let cachedFiles = loadFromPersistentCache(folderId, 0);

        if (cachedFiles) {
          console.log(`üìÑ Using cached data for batch ${batchKey}`);
          renderBatchFiles(cachedFiles, list, batchKey);
          spinner.style.display = "none";
          return;
        }

        try {
          console.log(`üåê Loading fresh data for batch ${batchKey}`);
          const response = await fetch(
            `https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents&key=${getNextApiKey()}&fields=files(id,name,mimeType,webViewLink)`
          );

          if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
          }

          const data = await response.json();

          // Save to persistent cache
          saveToPersistentCache(folderId, data.files || []);

          renderBatchFiles(data.files, list, batchKey);
        } catch (error) {
          list.innerHTML = `<li class="error-message">Error loading files: ${error.message}</li>`;
        }

        spinner.style.display = "none";
      }

      // Helper function to render batch files
      function renderBatchFiles(files, list, batchKey) {
        list.innerHTML = "";

        if (files) {
          // Sort files alphabetically by name
          files.sort((a, b) => a.name.localeCompare(b.name));

          files.forEach((file) => {
            const li = document.createElement("li");
            li.className = "drive-list-item";

            if (file.mimeType === "application/vnd.google-apps.folder") {
              // Folder with expand action only
              li.innerHTML = `
                <div class="folder-item">
                  <a href="https://drive.google.com/drive/folders/${file.id}" target="_blank" class="folder-link">
                    üìÅ ${file.name}
                  </a>
                  <div class="folder-actions">
                    <button class="expand-btn" onclick="toggleFolderExpansion('${file.id}', this)" title="Expand folder contents">
                      ‚ñº
                    </button>
                  </div>
                </div>
                <ul class="subfolder-list" id="subfolder-${file.id}" style="display: none;"></ul>
              `;
            } else {
              li.innerHTML = `<a href="${
                file.webViewLink ||
                `https://drive.google.com/file/d/${file.id}/view`
              }" target="_blank">üìÑ ${file.name}</a>`;
            }

            list.appendChild(li);
          });
        }
      }

      // Toggle folder expansion with caching
      async function toggleFolderExpansion(folderId, button) {
        const subfolderList = document.getElementById(`subfolder-${folderId}`);

        if (subfolderList.style.display === "none") {
          // Expand folder
          button.innerHTML = "‚ñ≤";
          button.title = "Collapse folder contents";
          subfolderList.style.display = "block";

          // Load folder contents if not already loaded
          if (subfolderList.children.length === 0) {
            subfolderList.innerHTML = '<li class="loading">Loading...</li>';

            // Check persistent cache first
            const cachedFiles = loadFromPersistentCache(folderId);
            if (cachedFiles) {
              console.log(`üìÑ Using cached data for folder ${folderId}`);
              renderSubfolderFiles(cachedFiles, subfolderList);
              return;
            }

            try {
              console.log(`üåê Loading fresh data for folder ${folderId}`);
              const response = await fetch(
                `https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents&key=${getNextApiKey()}&fields=files(id,name,mimeType,webViewLink)`
              );

              if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
              }

              const data = await response.json();

              // Save to persistent cache
              saveToPersistentCache(folderId, data.files || []);

              renderSubfolderFiles(data.files, subfolderList);
            } catch (error) {
              subfolderList.innerHTML = `<li class="error">Error loading: ${error.message}</li>`;
            }
          }
        } else {
          // Collapse folder
          button.innerHTML = "‚ñº";
          button.title = "Expand folder contents";
          subfolderList.style.display = "none";
        }
      }

      // Helper function to render subfolder files
      function renderSubfolderFiles(files, subfolderList) {
        subfolderList.innerHTML = "";

        if (files && files.length > 0) {
          // Sort files alphabetically by name
          files.sort((a, b) => a.name.localeCompare(b.name));

          files.forEach((file) => {
            const li = document.createElement("li");
            li.className = "subfolder-item";

            if (file.mimeType === "application/vnd.google-apps.folder") {
              // Nested folder with its own dropdown
              li.innerHTML = `
                <div class="folder-item">
                  <a href="https://drive.google.com/drive/folders/${file.id}" target="_blank" class="folder-link">
                    üìÅ ${file.name}
                  </a>
                  <div class="folder-actions">
                    <button class="expand-btn" onclick="toggleFolderExpansion('${file.id}', this)" title="Expand folder contents">
                      ‚ñº
                    </button>
                  </div>
                </div>
                <ul class="subfolder-list" id="subfolder-${file.id}" style="display: none;"></ul>
              `;
            } else {
              li.innerHTML = `
                <a href="${
                  file.webViewLink ||
                  `https://drive.google.com/file/d/${file.id}/view`
                }" target="_blank">
                  üìÑ ${file.name}
                </a>
              `;
            }

            subfolderList.appendChild(li);
          });
        } else {
          subfolderList.innerHTML = '<li class="empty">No files found</li>';
        }
      }

      // Initialize
      window.addEventListener("DOMContentLoaded", async () => {
        // Add spinners
        document.querySelectorAll(".drive-spinner").forEach((spinner) => {
          spinner.innerHTML = '<div class="loading-spinner"></div>';
        });

        // Clean expired cache on page load
        cleanExpiredCache();

        // Display cache status
        const stats = getCacheStats();
        if (stats.totalEntries > 0) {
          console.log(`üìä Cache Status:`, stats);
        }

        // Load mapping first, then load all batches
        await loadBatchMapping();

        // Create proper TOC mapping
        const tocMapping = {
          30: "30th Batch",
          29: "29th Batch",
          28: "28th Batch",
          27: "27th Batch",
          books: "Books & Slides",
          math: "Math II Notes",
          personal: "Personal Notes",
          syllabus: "Syllabus",
        };

        // Populate table of contents
        const toc = document.getElementById("table-of-contents");
        const batchKeys = Object.keys(batches);
        toc.innerHTML = batchKeys
          .map((batchKey) => {
            const displayName = tocMapping[batchKey] || `${batchKey}th Batch`;
            return `<li><a href="#batch-${batchKey}">${displayName}</a></li>`;
          })
          .join("");

        // Set up root folder buttons for batches loaded from JSON
        Object.entries(batches).forEach(([batchKey, folderId]) => {
          const rootBtn = document.getElementById(`root-btn-${batchKey}`);
          if (rootBtn) {
            rootBtn.onclick = () =>
              window.open(
                `https://drive.google.com/drive/folders/${folderId}`,
                "_blank"
              );
          }
          loadBatch(batchKey, folderId);
        });

        // Initialize TOC as collapsed
        const tocContent = document.getElementById("table-of-contents");
        tocContent.style.display = "none";
      });
    </script>
  </body>
</html>
