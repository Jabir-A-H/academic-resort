<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>3rd Semester - Academic Resort</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="../favicon.svg" />
    <link rel="stylesheet" href="../assets/styles.css" />
    <link rel="stylesheet" href="../assets/utilities.css" />
    <script src="../assets/api-keys.js"></script>
    <script src="../assets/cache-utils.js"></script>
    <script src="../assets/api-limiter.js"></script>
    <script src="../assets/drive-utils.js"></script>
    <script src="../assets/batch-loader.js"></script>
    <script src="../assets/script.js" defer></script>
  </head>
  <body>
    <div data-include="../assets/header.html"></div>
    <!-- App Header -->
    <header class="app-header">
      <h1>Academic Resort</h1>
    </header>
    <main class="container">
      <div class="page-intro">
        <h1 class="page-title">3rd Semester - Intermediate Foundation</h1>
        <p>
          <b>
            Explore comprehensive resources for all 3rd Semester courses. Each
            subject has its own dedicated page with organized materials,
            question banks, and teacher-specific resources.
          </b>
        </p>

        <!-- Subject Cards -->
        <div class="subjects-grid">
          <a
            href="../courses/2101-advanced-financial-accounting-i.html"
            class="subject-card"
          >
            <span class="subject-code">2101</span>
            <h3>Advanced Financial Accounting-I</h3>
          </a>

          <a href="../courses/2102-macroeconomics.html" class="subject-card">
            <span class="subject-code">2102</span>
            <h3>Macroeconomics</h3>
          </a>

          <a
            href="../courses/2103-programming-and-database-management.html"
            class="subject-card"
          >
            <span class="subject-code">2103</span>
            <h3>Programming and Database Management</h3>
          </a>

          <a
            href="../courses/2104-general-science-and-environment.html"
            class="subject-card"
          >
            <span class="subject-code">2104</span>
            <h3>General Science and Environment</h3>
          </a>

          <a
            href="../courses/2105-business-statistics-i.html"
            class="subject-card"
          >
            <span class="subject-code">2105</span>
            <h3>Business Statistics-I</h3>
          </a>
        </div>

        <!-- Traditional Table of Contents for Batch Archives -->
        <div class="toc-accordion">
          <div class="toc-header" onclick="toggleTOC()">
            <h4 class="font-weight-semibold">Batch Archives</h4>
            <span class="toc-toggle" id="toc-toggle">‚ñº</span>
          </div>
          <ul class="small toc-content" id="table-of-contents">
            <!-- Will be populated dynamically -->
          </ul>
        </div>
      </div>

      <!-- Dynamic batch list - populated from JSON files -->
      <div id="batches-container">
        <!-- Batch sections will be dynamically generated here -->
      </div>
    </main>

    <div data-include="../assets/footer.html"></div>

    <script>
      // Batch folders - loaded from JSON
      let batches = {};

      // API key restricted to jabir-a-h.github.io domain in Google Cloud Console
      // API keys are now loaded from api-keys.js for centralized management
      // Use getNextApiKey() to get API keys with automatic rotation

      // === SHARED UTILITIES ===
      // Cache management is now handled by shared CacheUtils
      // API rate limiting is now handled by shared APILimiter
      // Drive operations are now handled by shared DriveUtils

      // Page-specific cache prefix
      const PAGE_PREFIX = "3rd";

      // Make cache management functions available globally for debugging
      window.thirdSemesterCache = {
        stats: () => window.CacheUtils.getCacheStats(PAGE_PREFIX),
        clear: () => window.CacheUtils.clearPageCache(PAGE_PREFIX),
        cleanup: () => window.CacheUtils.cleanExpiredCache(PAGE_PREFIX),
      };

      // Load mapping from batch JSON files
      async function loadBatchMapping() {
        try {
          // Use the batch loader utility to get drive folder mapping for 3rd semester
          const mapping = await getDriveFolderMapping();

          // Extract 3rd semester batches
          if (mapping["3rd"]) {
            Object.entries(mapping["3rd"]).forEach(([batchKey, batchData]) => {
              batches[batchKey] = batchData.folderId;
            });
          }

          return batches;
        } catch (error) {
          console.error("Error loading batch mapping:", error);
          // No hardcoded fallbacks - rely entirely on JSON files
          return batches;
        }
      }

      // Create batch section HTML dynamically
      function createBatchSection(batchNumber, batchLabel) {
        return `
          <section class="drive-batch-container" id="batch-${batchNumber}">
            <div class="card drive-embed-card">
              <div class="batch-header">
                <h2>${batchLabel}</h2>
                <button
                  class="root-folder-btn"
                  id="root-btn-${batchNumber}"
                  title="Open root folder"
                >
                  ‚Üó
                </button>
              </div>
              <div class="drive-list-wrapper">
                <div class="drive-spinner" id="spinner-${batchNumber}"></div>
                <ul id="drive-list-${batchNumber}" class="drive-list"></ul>
              </div>
            </div>
          </section>
        `;
      }

      // Toggle TOC functionality
      function toggleTOC() {
        const content = document.getElementById("table-of-contents");
        const toggle = document.getElementById("toc-toggle");

        if (content.style.display === "none" || !content.style.display) {
          content.style.display = "block";
          toggle.textContent = "‚ñ≤";
        } else {
          content.style.display = "none";
          toggle.textContent = "‚ñº";
        }
      }

      // Load Drive folder contents
      async function loadBatch(batchNum, folderId) {
        const spinner = document.getElementById(`spinner-${batchNum}`);
        const list = document.getElementById(`drive-list-${batchNum}`);

        spinner.style.display = "block";

        try {
          // Use shared drive utilities for fetching with caching
          const files = await window.DriveUtils.fetchFolderContents(
            folderId,
            PAGE_PREFIX,
            0
          );
          renderBatchFiles(files, list, batchNum);
        } catch (error) {
          list.innerHTML = `<li class="error-message">Error loading files: ${error.message}</li>`;
        }

        spinner.style.display = "none";
      }

      // Helper function to render batch files
      function renderBatchFiles(files, list, batchNum) {
        list.innerHTML = "";

        if (files) {
          // Sort files alphabetically by name
          files.sort((a, b) => a.name.localeCompare(b.name));

          files.forEach((file) => {
            const li = document.createElement("li");
            li.className = "drive-list-item";

            if (file.mimeType === "application/vnd.google-apps.folder") {
              // Folder with expand action only
              li.innerHTML = `
                <div class="folder-item">
                  <a href="https://drive.google.com/drive/folders/${file.id}" target="_blank" class="folder-link">
                    üìÅ ${file.name}
                  </a>
                  <div class="folder-actions">
                    <button class="expand-btn" onclick="toggleFolderExpansion('${file.id}', this)" title="Expand folder contents">
                      ‚ñº
                    </button>
                  </div>
                </div>
                <ul class="subfolder-list" id="subfolder-${file.id}" style="display: none;"></ul>
              `;
            } else {
              li.innerHTML = `<a href="${
                file.webViewLink ||
                `https://drive.google.com/file/d/${file.id}/view`
              }" target="_blank">üìÑ ${file.name}</a>`;
            }

            list.appendChild(li);
          });
        }
      }

      // Toggle folder expansion with caching
      async function toggleFolderExpansion(folderId, button) {
        const subfolderList = document.getElementById(`subfolder-${folderId}`);

        if (subfolderList.style.display === "none") {
          // Expand folder
          button.innerHTML = "‚ñ≤";
          button.title = "Collapse folder contents";
          subfolderList.style.display = "block";

          // Load folder contents if not already loaded
          if (subfolderList.children.length === 0) {
            subfolderList.innerHTML = '<li class="loading">Loading...</li>';

            try {
              // Use shared drive utilities for fetching with caching
              const files = await window.DriveUtils.fetchFolderContents(
                folderId,
                PAGE_PREFIX,
                1
              );
              renderSubfolderFiles(files, subfolderList);
            } catch (error) {
              subfolderList.innerHTML = `<li class="error">Error loading: ${error.message}</li>`;
            }
          }
        } else {
          // Collapse folder
          button.innerHTML = "‚ñº";
          button.title = "Expand folder contents";
          subfolderList.style.display = "none";
        }
      }

      // Helper function to render subfolder files
      function renderSubfolderFiles(files, subfolderList) {
        subfolderList.innerHTML = "";

        if (files && files.length > 0) {
          // Sort files alphabetically by name
          files.sort((a, b) => a.name.localeCompare(b.name));

          files.forEach((file) => {
            const li = document.createElement("li");
            li.className = "subfolder-item";

            if (file.mimeType === "application/vnd.google-apps.folder") {
              // Nested folder with its own dropdown
              li.innerHTML = `
                <div class="folder-item">
                  <a href="https://drive.google.com/drive/folders/${file.id}" target="_blank" class="folder-link">
                    üìÅ ${file.name}
                  </a>
                  <div class="folder-actions">
                    <button class="expand-btn" onclick="toggleFolderExpansion('${file.id}', this)" title="Expand folder contents">
                      ‚ñº
                    </button>
                  </div>
                </div>
                <ul class="subfolder-list" id="subfolder-${file.id}" style="display: none;"></ul>
              `;
            } else {
              li.innerHTML = `
                <a href="${
                  file.webViewLink ||
                  `https://drive.google.com/file/d/${file.id}/view`
                }" target="_blank">
                  üìÑ ${file.name}
                </a>
              `;
            }

            subfolderList.appendChild(li);
          });
        } else {
          subfolderList.innerHTML = '<li class="empty">No files found</li>';
        }
      }

      // Initialize the page
      async function initializePage() {
        // Clean expired cache entries
        window.CacheUtils.cleanExpiredCache(PAGE_PREFIX);

        // Show cache stats (for debugging)
        const stats = window.CacheUtils.getCacheStats(PAGE_PREFIX);
        if (stats.validKeys > 0) {
          console.log(`üìä Cache Status:`, stats);
        }

        // Load mapping first, then dynamically generate batch sections
        await loadBatchMapping();

        const batchesContainer = document.getElementById("batches-container");
        const toc = document.getElementById("table-of-contents");
        const batchKeys = Object.keys(batches).sort(
          (a, b) => parseInt(b) - parseInt(a)
        ); // Sort descending

        // Populate table of contents
        toc.innerHTML = batchKeys
          .map(
            (batchNum) =>
              `<li><a href="#batch-${batchNum}">${batchNum}th Batch</a></li>`
          )
          .join("");

        // Generate batch sections dynamically and set up root folder buttons
        Object.entries(batches).forEach(([batchNumber, folderId]) => {
          const batchLabel = `${batchNumber}th Batch`;
          batchesContainer.innerHTML += createBatchSection(
            batchNumber,
            batchLabel
          );

          // Set up root folder button
          const rootBtn = document.getElementById(`root-btn-${batchNumber}`);
          if (rootBtn) {
            rootBtn.onclick = () => {
              window.open(
                `https://drive.google.com/drive/folders/${folderId}`,
                "_blank"
              );
            };
          }
        });

        // Load all batches
        Object.entries(batches).forEach(([batchNumber, folderId]) => {
          loadBatch(batchNumber, folderId);
        });
      }

      // Start initialization when DOM is ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initializePage);
      } else {
        initializePage();
      }
    </script>
  </body>
</html>
