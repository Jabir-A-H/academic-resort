<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Browse All Resources - Academic Resort</title>
    <link
      rel="preconnect"
      href="https://            try {
              const response = await fetch(
                `https://www.googleapis.com/drive/v3/files?q='${batchInfo.folderId}'+in+parents&key=${DRIVE_API_KEY}&fields=files(id,name,mimeType,webViewLink)`
              );
              
              if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
              }
              
              const data = await response.json();gleapis.com"
    />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/styles.css" />
    <script src="../assets/script.js" defer></script>
  </head>
  <body>
    <div data-include="../assets/includes/sidebar.html"></div>
    <header class="app-header"><h1>Academic Resort</h1></header>
    <main class="container">
      <div style="margin-bottom: 24px">
        <h1
          style="
            text-align: center;
            margin: 48px 0;
            font-size: 2.5rem;
            font-weight: 600;
          "
        >
          Browse All Resources
        </h1>
        <p>
          <b
            >Search and filter through all academic resources across all
            semesters and batches.</b
          >
        </p>
      </div>

      <!-- Advanced Search/Filter -->
      <div class="search-panel">
        <div class="search-row">
          <input
            type="text"
            id="globalSearch"
            placeholder="Search files, folders, teachers, courses..."
            oninput="globalFilter()"
          />
          <button
            id="deepSearchBtn"
            onclick="toggleDeepSearch()"
            title="Enable deep search to look inside nested folders"
          >
            üìÅ Deep Search: <span id="deepSearchStatus">OFF</span>
          </button>
        </div>

        <div class="filter-row">
          <select id="semesterFilter" onchange="globalFilter()">
            <option value="">All Semesters</option>
            <option value="1st">1st Semester</option>
            <option value="2nd">2nd Semester</option>
            <option value="3rd">3rd Semester</option>
            <option value="4th">4th Semester</option>
            <option value="5th">5th Semester</option>
            <option value="6th">6th Semester</option>
            <option value="7th">7th Semester</option>
            <option value="8th">8th Semester</option>
          </select>

          <select id="batchFilter" onchange="globalFilter()">
            <option value="">All Batches</option>
            <option value="30">30th Batch</option>
            <option value="29">29th Batch</option>
            <option value="28">28th Batch</option>
            <option value="27">27th Batch</option>
            <option value="26">26th Batch</option>
          </select>
        </div>
      </div>

      <!-- Results Container -->
      <div id="results-container">
        <div class="results-stats" id="resultsStats">Loading resources...</div>

        <!-- All Drive Resources will be loaded here -->
        <div id="all-resources"></div>
      </div>
    </main>

    <div data-include="../assets/includes/footer.html"></div>

    <script>
      // API key restricted to jabir-a-h.github.io domain in Google Cloud Console
      const DRIVE_API_KEY = "AIzaSyAEOadL6D0G_c8z5EB-sEp0T3hanYAnmF0";
      let ALL_DRIVE_RESOURCES = {}; // Will be loaded from JSON
      let allFiles = []; // Store all loaded files for filtering
      let deepSearchEnabled = false;
      let allDeepFiles = []; // Store deeply nested files when deep search is enabled

      // Recursive function to fetch all files from a folder and its subfolders
      async function fetchAllFilesRecursively(
        folderId,
        path = "",
        maxDepth = 5,
        currentDepth = 0
      ) {
        if (currentDepth >= maxDepth) return []; // Prevent infinite recursion

        try {
          const response = await fetch(
            `https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents&key=${DRIVE_API_KEY}&fields=files(id,name,mimeType,webViewLink)&pageSize=1000`
          );

          if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
          }

          const data = await response.json();
          let allFiles = [];

          if (data.files) {
            for (const file of data.files) {
              const filePath = path ? `${path}/${file.name}` : file.name;
              const fileData = {
                ...file,
                path: filePath,
                depth: currentDepth,
                isFolder:
                  file.mimeType === "application/vnd.google-apps.folder",
              };

              allFiles.push(fileData);

              // If it's a folder, recursively fetch its contents
              if (file.mimeType === "application/vnd.google-apps.folder") {
                const subFiles = await fetchAllFilesRecursively(
                  file.id,
                  filePath,
                  maxDepth,
                  currentDepth + 1
                );
                allFiles = allFiles.concat(subFiles);
              }
            }
          }

          return allFiles;
        } catch (error) {
          console.error(`Error fetching files from folder ${folderId}:`, error);
          return [];
        }
      }

      // Toggle deep search mode
      async function toggleDeepSearch() {
        const btn = document.getElementById("deepSearchBtn");
        const status = document.getElementById("deepSearchStatus");
        const stats = document.getElementById("resultsStats");

        deepSearchEnabled = !deepSearchEnabled;

        if (deepSearchEnabled) {
          status.textContent = "ON";
          btn.style.backgroundColor = "#4CAF50";
          btn.style.color = "white";
          stats.textContent = "Loading deep search... This may take a while.";

          // Load all files recursively
          allDeepFiles = [];
          for (const [semester, batches] of Object.entries(
            ALL_DRIVE_RESOURCES
          )) {
            for (const [batchKey, batchInfo] of Object.entries(batches)) {
              stats.textContent = `Deep scanning ${semester} - ${batchInfo.label}...`;
              try {
                const deepFiles = await fetchAllFilesRecursively(
                  batchInfo.folderId
                );
                deepFiles.forEach((file) => {
                  allDeepFiles.push({
                    ...file,
                    semester: semester,
                    batch: batchKey,
                    batchLabel: batchInfo.label,
                  });
                });
              } catch (error) {
                console.error(
                  `Error deep scanning ${semester} - ${batchInfo.label}:`,
                  error
                );
              }
            }
          }

          displayResults(allDeepFiles);
          updateStats(allDeepFiles.length, allDeepFiles.length);
          stats.textContent = `Deep search enabled - ${allDeepFiles.length} files found in nested folders`;
        } else {
          status.textContent = "OFF";
          btn.style.backgroundColor = "";
          btn.style.color = "";

          // Return to regular view
          displayResults(allFiles);
          updateStats(allFiles.length, allFiles.length);
          stats.textContent = `Showing ${allFiles.length} top-level files`;
        }
      }

      // Load mapping from JSON file
      async function loadDriveMapping() {
        try {
          const response = await fetch("../assets/drive-mapping.json");
          if (!response.ok)
            throw new Error(`Failed to load mapping: ${response.status}`);
          const mapping = await response.json();

          // Convert to the format expected by the rest of the code
          ALL_DRIVE_RESOURCES = {};
          Object.entries(mapping).forEach(([semester, semesterData]) => {
            ALL_DRIVE_RESOURCES[semester] = {};
            Object.entries(semesterData.batches).forEach(
              ([batchKey, batchData]) => {
                ALL_DRIVE_RESOURCES[semester][batchKey] = {
                  folderId: batchData.folderId,
                  label: batchData.label,
                };
              }
            );
          });

          return ALL_DRIVE_RESOURCES;
        } catch (error) {
          console.error("Error loading drive mapping:", error);
          // Fallback to basic structure if JSON fails
          ALL_DRIVE_RESOURCES = {
            "1st": {
              30: {
                folderId: "1ROStto-XpFTVfxyo9SLUL6Ou78pL6sat",
                label: "30th Batch",
              },
              29: {
                folderId: "1SV50Qd7OcbRsMd5tHzl0qXqW6BMdQ7uO",
                label: "29th Batch",
              },
            },
          };
          return ALL_DRIVE_RESOURCES;
        }
      }

      // Load all files from all drives
      async function loadAllResources() {
        // First load the mapping if not already loaded
        if (Object.keys(ALL_DRIVE_RESOURCES).length === 0) {
          await loadDriveMapping();
        }

        const container = document.getElementById("all-resources");
        const stats = document.getElementById("resultsStats");

        stats.textContent = "Loading all resources...";
        allFiles = [];

        for (const [semester, batches] of Object.entries(ALL_DRIVE_RESOURCES)) {
          for (const [batchKey, batchInfo] of Object.entries(batches)) {
            try {
              // Use local API server instead of direct Google Drive API
              const response = await fetch(
                `http://localhost:3000/api/drive/files?folderId=${batchInfo.folderId}`
              );

              if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
              }

              const data = await response.json();

              if (data.files) {
                data.files.forEach((file) => {
                  allFiles.push({
                    ...file,
                    semester: semester,
                    batch: batchKey,
                    batchLabel: batchInfo.label,
                    isFolder:
                      file.mimeType === "application/vnd.google-apps.folder",
                  });
                });
              }
            } catch (error) {
              console.error(
                `Error loading ${semester} - ${batchInfo.label}:`,
                error
              );
            }
          }
        }

        displayResults(allFiles);
        updateStats(allFiles.length, allFiles.length);
      }

      // Display search results
      function displayResults(files) {
        const container = document.getElementById("all-resources");
        container.innerHTML = "";

        if (files.length === 0) {
          container.innerHTML =
            '<div class="no-results">No files found matching your criteria.</div>';
          return;
        }

        // Group by semester
        const grouped = {};
        files.forEach((file) => {
          if (!grouped[file.semester]) grouped[file.semester] = {};
          if (!grouped[file.semester][file.batch])
            grouped[file.semester][file.batch] = [];
          grouped[file.semester][file.batch].push(file);
        });

        Object.entries(grouped).forEach(([semester, batches]) => {
          const semesterDiv = document.createElement("div");
          semesterDiv.className = "semester-group";
          semesterDiv.innerHTML = `<h2>${semester.toUpperCase()} Semester</h2>`;

          Object.entries(batches).forEach(([batch, files]) => {
            const batchDiv = document.createElement("div");
            batchDiv.className = "batch-group";
            batchDiv.innerHTML = `<h3>${files[0].batchLabel}</h3>`;

            const filesList = document.createElement("ul");
            filesList.className = "files-list";

            files.forEach((file) => {
              const li = document.createElement("li");
              li.className = `file-item ${file.isFolder ? "folder" : "file"}`;

              const icon = file.isFolder ? "üìÅ" : "üìÑ";
              const link =
                file.webViewLink ||
                `https://drive.google.com/file/d/${file.id}/view`;

              // Show file path in deep search mode
              const displayName =
                deepSearchEnabled && file.path ? file.path : file.name;
              const depthIndicator =
                deepSearchEnabled && file.depth > 0
                  ? `<span class="depth-indicator">üìÇ ${file.depth} levels deep</span>`
                  : "";

              li.innerHTML = `
                <a href="${link}" target="_blank" class="file-link">
                  ${icon} ${displayName}
                </a>
                ${depthIndicator}
                <span class="file-meta">${file.semester} - ${file.batchLabel}</span>
              `;

              filesList.appendChild(li);
            });

            batchDiv.appendChild(filesList);
            semesterDiv.appendChild(batchDiv);
          });

          container.appendChild(semesterDiv);
        });
      }

      // Global filter function
      function globalFilter() {
        const searchTerm = document
          .getElementById("globalSearch")
          .value.toLowerCase();
        const semesterFilter = document.getElementById("semesterFilter").value;
        const batchFilter = document.getElementById("batchFilter").value;

        // Use appropriate file array based on search mode
        const sourceFiles = deepSearchEnabled ? allDeepFiles : allFiles;

        let filtered = sourceFiles.filter((file) => {
          // Enhanced text search - includes file path for deep search
          const matchesSearch =
            !searchTerm ||
            file.name.toLowerCase().includes(searchTerm) ||
            file.batchLabel.toLowerCase().includes(searchTerm) ||
            (deepSearchEnabled &&
              file.path &&
              file.path.toLowerCase().includes(searchTerm));

          // Semester filter
          const matchesSemester =
            !semesterFilter || file.semester === semesterFilter;

          // Batch filter
          const matchesBatch = !batchFilter || file.batch === batchFilter;

          return matchesSearch && matchesSemester && matchesBatch;
        });

        displayResults(filtered);
        updateStats(filtered.length, sourceFiles.length);
      }

      // Update results statistics
      function updateStats(shown, total) {
        const stats = document.getElementById("resultsStats");
        stats.textContent = `Showing ${shown} of ${total} resources`;
      }

      // Initialize on page load
      window.addEventListener("DOMContentLoaded", () => {
        loadAllResources();
      });
    </script>

    <style>
      .search-panel {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 24px;
      }

      .search-row {
        margin-bottom: 16px;
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .search-row input {
        flex: 1;
        padding: 12px 16px;
        font-size: 1.1rem;
        border: 1px solid #ddd;
        border-radius: 6px;
      }

      #deepSearchBtn {
        padding: 12px 16px;
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        white-space: nowrap;
        transition: all 0.3s ease;
      }

      #deepSearchBtn:hover {
        background-color: #e0e0e0;
      }

      .depth-indicator {
        font-size: 0.8rem;
        color: #666;
        margin-left: 8px;
        padding: 2px 6px;
        background-color: #f0f0f0;
        border-radius: 3px;
      }

      .filter-row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .filter-row select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
        min-width: 150px;
      }

      .results-stats {
        margin-bottom: 16px;
        font-weight: 600;
        color: #666;
      }

      .semester-group {
        margin-bottom: 32px;
        border-left: 4px solid #2196f3;
        padding-left: 16px;
      }

      .semester-group h2 {
        margin: 0 0 16px 0;
        color: #2196f3;
      }

      .batch-group {
        margin-bottom: 24px;
        background: #fff;
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .batch-group h3 {
        margin: 0 0 12px 0;
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
      }

      .files-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .file-item {
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .file-item:last-child {
        border-bottom: none;
      }

      .file-link {
        text-decoration: none;
        color: #2196f3;
        font-weight: 500;
      }

      .file-link:hover {
        text-decoration: underline;
      }

      .file-meta {
        font-size: 0.9rem;
        color: #666;
        font-style: italic;
      }

      .no-results {
        text-align: center;
        padding: 48px;
        color: #666;
        font-size: 1.1rem;
      }

      @media (max-width: 768px) {
        .filter-row {
          flex-direction: column;
        }

        .filter-row select {
          min-width: 100%;
        }

        .file-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 4px;
        }
      }
    </style>
  </body>
</html>
