<!-- Subject Page Template -->
<script>
  // Global subject page functions
  window.toggleTOC = function() {
    try {
      const content = document.getElementById('table-of-contents');
      const toggle = document.getElementById('toc-toggle');
      if (content && toggle) {
        const isExpanded = content.style.display !== 'none';
        content.style.display = isExpanded ? 'none' : 'block';
        toggle.textContent = isExpanded ? '‚ñº' : '‚ñ≤';
      }
    } catch (error) {
      console.error('Error in toggleTOC:', error);
    }
  };

  window.toggleSection = function(sectionId) {
    try {
      const section = document.getElementById(sectionId);
      if (!section) return;
      
      const content = section.querySelector('.section-content');
      const toggle = section.querySelector('.toggle-icon');
      
      if (content && toggle) {
        const isExpanded = content.style.display !== 'none';
        content.style.display = isExpanded ? 'none' : 'block';
        toggle.textContent = isExpanded ? '‚ñº' : '‚ñ≤';
        section.classList.toggle('collapsed', isExpanded);
      }
    } catch (error) {
      console.error('Error in toggleSection:', error);
    }
  };

  window.toggleSubsection = function(subsectionId) {
    try {
      const subsection = document.getElementById(subsectionId);
      if (!subsection) return;
      
      const content = subsection.querySelector('.subsection-content');
      const toggle = subsection.querySelector('.toggle-icon');
      
      if (content && toggle) {
        const isExpanded = content.style.display !== 'none';
        content.style.display = isExpanded ? 'none' : 'block';
        toggle.textContent = isExpanded ? '‚ñº' : '‚ñ≤';
        subsection.classList.toggle('collapsed', isExpanded);
      }
    } catch (error) {
      console.error('Error in toggleSubsection:', error);
    }
  };

  // Subject page configuration that will be set by each page
  window.subjectConfig = window.subjectConfig || {};
  
  function initializeSubjectPage() {
    try {
      const config = window.subjectConfig;
      if (!config) {
        console.error('Subject configuration not found');
        return;
      }
      
      // Update breadcrumb
      updateBreadcrumb(config);
      
      // Update page title and description  
      updatePageHeader(config);
      
      // Create standardized sections
      createStandardizedSections(config);
      
      // Initialize collapsible sections
      initializeCollapsibleSections();
      
      // Load drive content
      loadDriveContent(config);
      
      console.log('Subject page initialized successfully for:', config.title);
    } catch (error) {
      console.error('Error initializing subject page:', error);
    }
  }

  async function loadDriveContent(config) {
    try {
      // Load subject-specific JSON mapping
      const response = await fetch(`../../assets/subjects/${config.code}.json`);
      if (!response.ok) {
        console.warn('Could not load subject mapping for:', config.code);
        return;
      }
      
      const subjectData = await response.json();
      
      // Populate sections with subject-specific drive links
      populateSubjectLinks(subjectData);
      
    } catch (error) {
      console.error('Error loading subject content:', error);
    }
  }

  function populateSubjectLinks(subjectData) {
    if (!subjectData.study_materials) return;
    
    const studyMaterials = subjectData.study_materials;
    
    // Class Updates
    const classUpdatesContent = document.getElementById('class-updates-content');
    if (classUpdatesContent && studyMaterials.class_updates) {
      classUpdatesContent.innerHTML = createContentLinks(studyMaterials.class_updates.links);
    }
    
    // Personal Notes
    const personalNotesContent = document.getElementById('personal-notes-content');
    if (personalNotesContent && studyMaterials.notes) {
      let notesHTML = '';
      if (studyMaterials.notes.current) {
        notesHTML += createContentLinks(studyMaterials.notes.current);
      }
      if (studyMaterials.notes.previous && studyMaterials.notes.previous.length > 0) {
        notesHTML += createContentLinks(studyMaterials.notes.previous);
      }
      personalNotesContent.innerHTML = notesHTML || 'No notes available yet.';
    }
    
    // Slides and Lectures
    const slidesContent = document.getElementById('slides-content');
    if (slidesContent && studyMaterials.slides_lectures) {
      let slidesHTML = '';
      if (studyMaterials.slides_lectures.current) {
        slidesHTML += createContentLinks(studyMaterials.slides_lectures.current);
      }
      if (studyMaterials.slides_lectures.previous && studyMaterials.slides_lectures.previous.length > 0) {
        slidesHTML += createContentLinks(studyMaterials.slides_lectures.previous);
      }
      slidesContent.innerHTML = slidesHTML || 'No slide materials available yet.';
    }
    
    // Books and Manuals
    const booksContent = document.getElementById('books-content');
    if (booksContent && studyMaterials.books_manuals) {
      let booksHTML = '';
      if (studyMaterials.books_manuals.current) {
        booksHTML += createContentLinks(studyMaterials.books_manuals.current);
      }
      if (studyMaterials.books_manuals.previous && studyMaterials.books_manuals.previous.length > 0) {
        booksHTML += createContentLinks(studyMaterials.books_manuals.previous);
      }
      booksContent.innerHTML = booksHTML || 'No books/manuals available yet.';
    }
    
    // Previous Materials
    const previousContent = document.getElementById('previous-materials-content');
    if (previousContent && studyMaterials.previous_materials) {
      previousContent.innerHTML = createContentLinks(studyMaterials.previous_materials.links);
    }
    
    // Questions sections
    if (subjectData.questions) {
      const currentQuestionsContent = document.getElementById('current-questions-content');
      if (currentQuestionsContent && subjectData.questions.current_questions) {
        currentQuestionsContent.innerHTML = createContentLinks(subjectData.questions.current_questions);
      }
      
      const previousQuestionsContent = document.getElementById('previous-questions-content');
      if (previousQuestionsContent && subjectData.questions.previous_questions) {
        previousQuestionsContent.innerHTML = createContentLinks(subjectData.questions.previous_questions);
      }
    }
  }

  function createContentLinks(links) {
    if (!links || links.length === 0) return 'No content available yet.';
    
    return links.map(link => {
      if (link.folderId) {
        return createDriveLink(link.folderId, link.label);
      } else if (link.url) {
        return createDocumentLink(link.url, link.label);
      } else {
        return `<div class="placeholder-link">${link.label} (Coming soon)</div>`;
      }
    }).join('<br>');
  }

  function createDocumentLink(url, label) {
    if (!url) {
      return `<div class="placeholder-link">${label} (Coming soon)</div>`;
    }
    return `<a href="${url}" target="_blank" rel="noopener" class="drive-link">
      <span class="drive-icon">üìÑ</span>
      ${label}
    </a>`;
  }

  function createDriveLink(folderId, label) {
    return `<a href="https://drive.google.com/drive/folders/${folderId}" target="_blank" rel="noopener" class="drive-link">
      <span class="drive-icon">üìÅ</span>
      ${label}
    </a>`;
  }
  
  function updateBreadcrumb(config) {
    const breadcrumb = document.querySelector('.breadcrumb');
    if (breadcrumb) {
      breadcrumb.innerHTML = `
        <a href="../../index.html">Home</a> >
        <a href="../${config.semesterPage}">${config.semesterName}</a> >
        <span>${config.title}</span>
      `;
    }
  }
  
  function updatePageHeader(config) {
    const pageTitle = document.querySelector('.page-title');
    const pageDescription = document.querySelector('.page-description');
    const quickActions = document.querySelector('.quick-actions');
    
    if (pageTitle) {
      pageTitle.textContent = `${config.title} (${config.code})`;
    }
    
    if (pageDescription) {
      pageDescription.innerHTML = `<b>${config.description}</b>`;
    }
    
    if (quickActions) {
      quickActions.innerHTML = `
        <a href="../course-teachers.html?course=${config.code}" class="action-btn">
          <span class="icon">Teachers</span>
          View Teachers
        </a>
        <a href="../browse.html?search=${config.code}" class="action-btn">
          <span class="icon">Search</span>
          Search Resources
        </a>
        <a href="../${config.semesterPage}" class="action-btn">
          <span class="icon">Back</span>
          All ${config.semesterName}
        </a>
      `;
    }
  }
  
  function createStandardizedSections(config) {
    const container = document.querySelector('.subject-content');
    if (!container) return;
    
    container.innerHTML = `
      <!-- Course Overview -->
      <section class="card collapsible-section" id="overview">
        <div class="section-header" onclick="toggleSection('overview')">
          <h2>Course Overview</h2>
          <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="section-content">
          <div class="course-info-grid">
            <div class="info-card">
              <h4>Course Code:</h4>
              <p>${config.code}</p>
            </div>
            <div class="info-card">
              <h4>Course Title:</h4>
              <p>${config.title}</p>
            </div>
          </div>
          <div class="course-description">
            <p>${config.description}</p>
          </div>
        </div>
      </section>

      <!-- Study Materials Section -->
      <section class="card collapsible-section" id="study">
        <div class="section-header" onclick="toggleSection('study')">
          <h2>Study Materials</h2>
          <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="section-content">
          <div class="subsection collapsible-subsection" id="class-updates">
            <div class="subsection-header" onclick="toggleSubsection('class-updates')">
              <h3>Class Updates</h3>
              <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="subsection-content">
              <p>Latest class updates and announcements</p>
              <div class="resource-placeholder" id="class-updates-content">Loading content...</div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="personal-notes">
            <div class="subsection-header" onclick="toggleSubsection('personal-notes')">
              <h3>Personal Notes</h3>
              <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="subsection-content">
              <p>Student-created study notes and summaries</p>
              <div class="resource-placeholder" id="personal-notes-content">Loading content...</div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="slides-lectures">
            <div class="subsection-header" onclick="toggleSubsection('slides-lectures')">
              <h3>Slides and Lecture Materials</h3>
              <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="subsection-content">
              <p>Official lecture slides and presentation materials</p>
              <div class="resource-placeholder" id="slides-content">Loading content...</div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="books-manuals">
            <div class="subsection-header" onclick="toggleSubsection('books-manuals')">
              <h3>Books and Manuals</h3>
              <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="subsection-content">
              <p>Textbooks, reference materials, and official manuals</p>
              <div class="resource-placeholder" id="books-content">Loading content...</div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="previous-materials">
            <div class="subsection-header" onclick="toggleSubsection('previous-materials')">
              <h3>Previous Materials</h3>
              <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="subsection-content">
              <p>Materials from previous batches and semesters</p>
              <div class="resource-placeholder" id="previous-materials-content">Loading content...</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Questions Section -->
      <section class="card collapsible-section" id="questions">
        <div class="section-header" onclick="toggleSection('questions')">
          <h2>Questions & Examinations</h2>
          <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="section-content">
          <div class="subsection collapsible-subsection" id="class-test">
            <div class="subsection-header" onclick="toggleSubsection('class-test')">
              <h3>Class Test Questions</h3>
              <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="subsection-content">
              <div class="resource-placeholder" id="class-test-content">
                <p>Class test questions will be added here.</p>
              </div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="midterm">
            <div class="subsection-header" onclick="toggleSubsection('midterm')">
              <h3>Midterm Questions</h3>
              <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="subsection-content">
              <div class="resource-placeholder" id="midterm-content">
                <p>Midterm questions will be added here.</p>
              </div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="final">
            <div class="subsection-header" onclick="toggleSubsection('final')">
              <h3>Final Questions</h3>
              <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="subsection-content">
              <div class="resource-placeholder" id="final-content">
                <p>Final exam questions will be added here.</p>
              </div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="question-banks">
            <div class="subsection-header" onclick="toggleSubsection('question-banks')">
              <h3>Question Banks</h3>
              <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="subsection-content">
              <div class="resource-placeholder" id="question-banks-content">
                <p>Comprehensive question banks will be added here.</p>
              </div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="test-banks">
            <div class="subsection-header" onclick="toggleSubsection('test-banks')">
              <h3>Test Banks</h3>
              <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="subsection-content">
              <div class="resource-placeholder" id="test-banks-content">
                <p>Test banks and practice materials will be added here.</p>
              </div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="current-questions">
            <div class="subsection-header" onclick="toggleSubsection('current-questions')">
              <h3>Current Questions</h3>
              <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="subsection-content">
              <div class="resource-placeholder" id="current-questions-content">Loading content...</div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="previous-questions">
            <div class="subsection-header" onclick="toggleSubsection('previous-questions')">
              <h3>Previous Questions</h3>
              <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="subsection-content">
              <div class="resource-placeholder" id="previous-questions-content">Loading content...</div>
            </div>
          </div>
        </div>
      </section>
    `;
  }
  
  function initializeCollapsibleSections() {
    try {
      // Start with all sections collapsed except overview
      const sections = document.querySelectorAll('.collapsible-section');
      sections.forEach((section, index) => {
        const content = section.querySelector('.section-content');
        const icon = section.querySelector('.toggle-icon');
        
        if (content && icon) {
          if (index === 0) { // Keep first section (overview) open
            content.style.display = 'block';
            icon.textContent = '‚ñ≤';
          } else {
            content.style.display = 'none';
            icon.textContent = '‚ñº';
          }
        }
      });
      
      // Start with all subsections collapsed
      const subsections = document.querySelectorAll('.collapsible-subsection');
      subsections.forEach(subsection => {
        const content = subsection.querySelector('.subsection-content');
        const icon = subsection.querySelector('.toggle-icon');
        if (content && icon) {
          content.style.display = 'none';
          icon.textContent = '‚ñº';
        }
      });
    } catch (error) {
      console.error('Error initializing collapsible sections:', error);
    }
  }
  
  // Add CSS for drive links
  if (!document.querySelector('#drive-links-css')) {
    const styleElement = document.createElement('style');
    styleElement.id = 'drive-links-css';
    styleElement.textContent = `
      .drive-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border: 1px solid #dee2e6;
        border-radius: 6px;
        text-decoration: none;
        color: #495057;
        font-size: 14px;
        transition: all 0.2s ease;
        margin-bottom: 8px;
      }

      .drive-link:hover {
        background: linear-gradient(135deg, #e9ecef, #dee2e6);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .drive-icon {
        font-size: 16px;
      }

      .placeholder-link {
        display: inline-block;
        padding: 8px 12px;
        background: #f8f9fa;
        border: 1px dashed #ced4da;
        border-radius: 6px;
        color: #6c757d;
        font-size: 14px;
        font-style: italic;
        margin-bottom: 8px;
      }
    `;
    document.head.appendChild(styleElement);
  }
  
  // Auto-initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeSubjectPage);
  } else {
    // DOM already loaded
    setTimeout(initializeSubjectPage, 100);
  }
</script>