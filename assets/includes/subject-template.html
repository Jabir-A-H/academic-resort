<!-- Subject Page Template -->
<script>
  // Global subject page functions
  window.toggleTOC = function() {
    try {
      const content = document.getElementById('table-of-contents');
      const toggle = document.getElementById('toc-toggle');
      if (content && toggle) {
        const isExpanded = content.style.display !== 'none';
        content.style.display = isExpanded ? 'none' : 'block';
        toggle.textContent = isExpanded ? '‚ñº' : '‚ñ≤';
      }
    } catch (error) {
      console.error('Error in toggleTOC:', error);
    }
  };

  window.toggleSection = function(sectionId) {
    try {
      const section = document.getElementById(sectionId);
      if (!section) return;
      
      const content = section.querySelector('.section-content');
      const toggle = section.querySelector('.toggle-icon');
      
      if (content && toggle) {
        const isExpanded = content.style.display !== 'none';
        content.style.display = isExpanded ? 'none' : 'block';
        toggle.textContent = isExpanded ? '‚ñº' : '‚ñ≤';
        section.classList.toggle('collapsed', isExpanded);
      }
    } catch (error) {
      console.error('Error in toggleSection:', error);
    }
  };

  window.toggleSubsection = function(subsectionId) {
    try {
      const subsection = document.getElementById(subsectionId);
      if (!subsection) return;
      
      const content = subsection.querySelector('.subsection-content');
      const toggle = subsection.querySelector('.toggle-icon');
      
      if (content && toggle) {
        const isExpanded = content.style.display !== 'none';
        content.style.display = isExpanded ? 'none' : 'block';
        toggle.textContent = isExpanded ? '‚ñº' : '‚ñ≤';
        subsection.classList.toggle('collapsed', isExpanded);
      }
    } catch (error) {
      console.error('Error in toggleSubsection:', error);
    }
  };

  // Subject page configuration that will be set by each page
  window.subjectConfig = window.subjectConfig || {};
  
  function initializeSubjectPage() {
    try {
      const config = window.subjectConfig;
      if (!config) {
        console.error('Subject configuration not found');
        return;
      }
      
      // Update breadcrumb
      updateBreadcrumb(config);
      
      // Update page title and description  
      updatePageHeader(config);
      
      // Create standardized sections
      createStandardizedSections(config);
      
      // Initialize collapsible sections
      initializeCollapsibleSections();
      
      // Load drive content
      loadDriveContent(config);
      
      console.log('Subject page initialized successfully for:', config.title);
    } catch (error) {
      console.error('Error initializing subject page:', error);
    }
  }

  async function loadDriveContent(config) {
    try {
      // Load drive mapping
      const response = await fetch('../../assets/drive-mapping.json');
      if (!response.ok) {
        console.warn('Could not load drive mapping');
        return;
      }
      
      const driveData = await response.json();
      const semesterKey = config.semesterPage.replace('.html', ''); // '1st', '2nd', etc.
      const semesterData = driveData[semesterKey];
      
      if (!semesterData) {
        console.warn('No drive data found for semester:', semesterKey);
        return;
      }
      
      // Populate sections with drive links
      populateDriveLinks(semesterData);
      
    } catch (error) {
      console.error('Error loading drive content:', error);
    }
  }

  function populateDriveLinks(semesterData) {
    if (!semesterData.batches) return;
    
    // Personal Notes
    const personalNotesContent = document.getElementById('personal-notes-content');
    if (personalNotesContent && semesterData.batches.personal) {
      personalNotesContent.innerHTML = createDriveLink(
        semesterData.batches.personal.folderId, 
        semesterData.batches.personal.label
      );
    }
    
    // Books and Slides
    const booksContent = document.getElementById('books-content');
    if (booksContent && semesterData.batches.books) {
      booksContent.innerHTML = createDriveLink(
        semesterData.batches.books.folderId, 
        semesterData.batches.books.label
      );
    } else if (booksContent && semesterData.batches.syllabus) {
      booksContent.innerHTML = createDriveLink(
        semesterData.batches.syllabus.folderId, 
        semesterData.batches.syllabus.label
      );
    }
    
    // Slides content - use available batch materials
    const slidesContent = document.getElementById('slides-content');
    if (slidesContent) {
      let slidesHTML = '';
      Object.entries(semesterData.batches).forEach(([key, batch]) => {
        if (key !== 'personal' && key !== 'books' && key !== 'syllabus' && batch.folderId) {
          slidesHTML += createDriveLink(batch.folderId, batch.label) + '<br>';
        }
      });
      slidesContent.innerHTML = slidesHTML || 'No slide materials available yet.';
    }
  }

  function createDriveLink(folderId, label) {
    return `<a href="https://drive.google.com/drive/folders/${folderId}" target="_blank" rel="noopener" class="drive-link">
      <span class="drive-icon">üìÅ</span>
      ${label}
    </a>`;
  }
  
  function updateBreadcrumb(config) {
    const breadcrumb = document.querySelector('.breadcrumb');
    if (breadcrumb) {
      breadcrumb.innerHTML = `
        <a href="../../index.html">Home</a> >
        <a href="../${config.semesterPage}">${config.semesterName}</a> >
        <span>${config.title}</span>
      `;
    }
  }
  
  function updatePageHeader(config) {
    const pageTitle = document.querySelector('.page-title');
    const pageDescription = document.querySelector('.page-description');
    const quickActions = document.querySelector('.quick-actions');
    
    if (pageTitle) {
      pageTitle.textContent = `${config.title} (${config.code})`;
    }
    
    if (pageDescription) {
      pageDescription.innerHTML = `<b>${config.description}</b>`;
    }
    
    if (quickActions) {
      quickActions.innerHTML = `
        <a href="../course-teachers.html?course=${config.code}" class="action-btn">
          <span class="icon">Teachers</span>
          View Teachers
        </a>
        <a href="../browse.html?search=${config.code}" class="action-btn">
          <span class="icon">Search</span>
          Search Resources
        </a>
        <a href="../${config.semesterPage}" class="action-btn">
          <span class="icon">Back</span>
          All ${config.semesterName}
        </a>
      `;
    }
  }
  
  function createStandardizedSections(config) {
    const container = document.querySelector('.subject-content');
    if (!container) return;
    
    container.innerHTML = `
      <!-- Course Overview -->
      <section class="card collapsible-section" id="overview">
        <div class="section-header" onclick="toggleSection('overview')">
          <h2>Course Overview</h2>
          <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="section-content">
          <div class="course-info-grid">
            <div class="info-card">
              <h4>Course Code:</h4>
              <p>${config.code}</p>
            </div>
            <div class="info-card">
              <h4>Course Title:</h4>
              <p>${config.title}</p>
            </div>
            <div class="info-card">
              <h4>Credit Hours:</h4>
              <p>${config.credits || '3 Credits'}</p>
            </div>
            <div class="info-card">
              <h4>Semester:</h4>
              <p>${config.semesterName}</p>
            </div>
            <div class="info-card">
              <h4>Prerequisites:</h4>
              <p>${config.prerequisites || 'None'}</p>
            </div>
          </div>
          <div class="course-description">
            <p>${config.detailedDescription}</p>
          </div>
        </div>
      </section>

      <!-- Study Materials Section -->
      <section class="card collapsible-section" id="study">
        <div class="section-header" onclick="toggleSection('study')">
          <h2>Study Materials</h2>
          <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="section-content">
          <div class="subsection collapsible-subsection" id="personal-notes">
            <div class="subsection-header" onclick="toggleSubsection('personal-notes')">
              <h3>Personal Notes</h3>
              <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="subsection-content">
              <p>Student-created study notes and summaries</p>
              <div class="resource-placeholder" id="personal-notes-content">Loading content...</div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="slides-lectures">
            <div class="subsection-header" onclick="toggleSubsection('slides-lectures')">
              <h3>Slides and Lecture Materials</h3>
              <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="subsection-content">
              <p>Official lecture slides and presentation materials</p>
              <div class="resource-placeholder" id="slides-content">Loading content...</div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="books-manuals">
            <div class="subsection-header" onclick="toggleSubsection('books-manuals')">
              <h3>Books and Manuals</h3>
              <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="subsection-content">
              <p>Textbooks, reference materials, and official manuals</p>
              <div class="resource-placeholder" id="books-content">Loading content...</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Questions Section -->
      <section class="card collapsible-section" id="questions">
        <div class="section-header" onclick="toggleSection('questions')">
          <h2>Questions & Examinations</h2>
          <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="section-content">
          <div class="subsection collapsible-subsection" id="class-test">
            <div class="subsection-header" onclick="toggleSubsection('class-test')">
              <h3>Class Test Questions</h3>
              <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="subsection-content">
              <div class="question-bank">
                ${config.classTestQuestions || '<p>Class test questions will be added here.</p>'}
              </div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="midterm">
            <div class="subsection-header" onclick="toggleSubsection('midterm')">
              <h3>Midterm Questions</h3>
              <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="subsection-content">
              <div class="question-bank">
                ${config.midtermQuestions || '<p>Midterm questions will be added here.</p>'}
              </div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="final">
            <div class="subsection-header" onclick="toggleSubsection('final')">
              <h3>Final Questions</h3>
              <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="subsection-content">
              <div class="question-bank">
                ${config.finalQuestions || '<p>Final exam questions will be added here.</p>'}
              </div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="question-banks">
            <div class="subsection-header" onclick="toggleSubsection('question-banks')">
              <h3>Question Banks</h3>
              <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="subsection-content">
              <div class="question-bank">
                ${config.questionBanks || '<p>Comprehensive question banks will be added here.</p>'}
              </div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="test-banks">
            <div class="subsection-header" onclick="toggleSubsection('test-banks')">
              <h3>Test Banks</h3>
              <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="subsection-content">
              <div class="question-bank">
                ${config.testBanks || '<p>Test banks and practice materials will be added here.</p>'}
              </div>
            </div>
          </div>
        </div>
      </section>
    `;
  }
  
  function initializeCollapsibleSections() {
    try {
      // Start with all sections collapsed except overview
      const sections = document.querySelectorAll('.collapsible-section');
      sections.forEach((section, index) => {
        const content = section.querySelector('.section-content');
        const icon = section.querySelector('.toggle-icon');
        
        if (content && icon) {
          if (index === 0) { // Keep first section (overview) open
            content.style.display = 'block';
            icon.textContent = '‚ñ≤';
          } else {
            content.style.display = 'none';
            icon.textContent = '‚ñº';
          }
        }
      });
      
      // Start with all subsections collapsed
      const subsections = document.querySelectorAll('.collapsible-subsection');
      subsections.forEach(subsection => {
        const content = subsection.querySelector('.subsection-content');
        const icon = subsection.querySelector('.toggle-icon');
        if (content && icon) {
          content.style.display = 'none';
          icon.textContent = '‚ñº';
        }
      });
    } catch (error) {
      console.error('Error initializing collapsible sections:', error);
    }
  }
  
  // Add CSS for drive links
  if (!document.querySelector('#drive-links-css')) {
    const styleElement = document.createElement('style');
    styleElement.id = 'drive-links-css';
    styleElement.textContent = `
      .drive-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border: 1px solid #dee2e6;
        border-radius: 6px;
        text-decoration: none;
        color: #495057;
        font-size: 14px;
        transition: all 0.2s ease;
        margin-bottom: 8px;
      }

      .drive-link:hover {
        background: linear-gradient(135deg, #e9ecef, #dee2e6);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .drive-icon {
        font-size: 16px;
      }
    `;
    document.head.appendChild(styleElement);
  }
  
  // Auto-initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeSubjectPage);
  } else {
    // DOM already loaded
    setTimeout(initializeSubjectPage, 100);
  }
</script>