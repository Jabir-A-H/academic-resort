<!-- Subject Page Template -->
<script>
  // Global subject page functions
  window.toggleTOC = function() {
    try {
      const content = document.getElementById('table-of-contents');
      const toggle = document.getElementById('toc-toggle');
      if (content && toggle) {
        const isExpanded = content.style.display !== 'none';
        content.style.display = isExpanded ? 'none' : 'block';
        toggle.textContent = isExpanded ? '‚ñº' : '‚ñ≤';
      }
    } catch (error) {
      console.error('Error in toggleTOC:', error);
    }
  };

  window.toggleSection = function(sectionId) {
    try {
      const section = document.getElementById(sectionId);
      if (!section) return;
      
      const content = section.querySelector('.section-content');
      const toggle = section.querySelector('.toggle-icon');
      
      if (content && toggle) {
        const isExpanded = content.style.display !== 'none';
        content.style.display = isExpanded ? 'none' : 'block';
        toggle.textContent = isExpanded ? '‚ñº' : '‚ñ≤';
        section.classList.toggle('collapsed', isExpanded);
      }
    } catch (error) {
      console.error('Error in toggleSection:', error);
    }
  };

  window.toggleSubsection = function(subsectionId) {
    try {
      const subsection = document.getElementById(subsectionId);
      if (!subsection) return;
      
      const content = subsection.querySelector('.subsection-content');
      const toggle = subsection.querySelector('.toggle-icon');
      
      if (content && toggle) {
        const isExpanded = content.style.display !== 'none';
        content.style.display = isExpanded ? 'none' : 'block';
        toggle.textContent = isExpanded ? '‚ñº' : '‚ñ≤';
        subsection.classList.toggle('collapsed', isExpanded);
      }
    } catch (error) {
      console.error('Error in toggleSubsection:', error);
    }
  };

  // Subject page configuration that will be set by each page
  window.subjectConfig = window.subjectConfig || {};
  
  function initializeSubjectPage() {
    try {
      const config = window.subjectConfig;
      if (!config) {
        console.error('Subject configuration not found');
        return;
      }
      
      // Update breadcrumb
      updateBreadcrumb(config);
      
      // Update page title and description  
      updatePageHeader(config);
      
      // Create standardized sections
      createStandardizedSections(config);
      
      // Initialize collapsible sections
      initializeCollapsibleSections();
      
      // Load drive content
      loadDriveContent(config);
      
      console.log('Subject page initialized successfully for:', config.title);
    } catch (error) {
      console.error('Error initializing subject page:', error);
    }
  }

  async function loadDriveContent(config) {
    try {
      // Load subject-specific JSON mapping
      const response = await fetch(`../../assets/subjects/${config.code}.json`);
      if (!response.ok) {
        console.warn('Could not load subject mapping for:', config.code);
        return;
      }
      
      const subjectData = await response.json();
      
      // Populate sections with subject-specific drive links
      populateSubjectLinks(subjectData);
      
    } catch (error) {
      console.error('Error loading subject content:', error);
    }
  }

  function populateSubjectLinks(subjectData) {
    if (!subjectData.study_materials) return;
    
    const studyMaterials = subjectData.study_materials;
    
    // Class Updates - Simple document link
    const classUpdatesContent = document.getElementById('class-updates-content');
    if (classUpdatesContent && studyMaterials.class_updates) {
      if (studyMaterials.class_updates.url) {
        classUpdatesContent.innerHTML = `
          <a href="${studyMaterials.class_updates.url}" target="_blank" rel="noopener" class="document-link">
            <span class="doc-icon">üìÑ</span>
            ${studyMaterials.class_updates.label}
          </a>
        `;
      } else {
        classUpdatesContent.innerHTML = `
          <div class="placeholder-link">
            ${studyMaterials.class_updates.label} (Coming soon)
          </div>
        `;
      }
    }
    
    // Personal Notes
    const personalNotesContent = document.getElementById('personal-notes-content');
    if (personalNotesContent && studyMaterials.notes) {
      let notesHTML = '';
      if (studyMaterials.notes.current) {
        notesHTML += createContentLinks(studyMaterials.notes.current);
      }
      if (studyMaterials.notes.previous && studyMaterials.notes.previous.length > 0) {
        notesHTML += createContentLinks(studyMaterials.notes.previous);
      }
      personalNotesContent.innerHTML = notesHTML || 'No notes available yet.';
    }
    
    // Slides and Lectures
    const slidesContent = document.getElementById('slides-content');
    if (slidesContent && studyMaterials.slides_lectures) {
      let slidesHTML = '';
      if (studyMaterials.slides_lectures.current) {
        slidesHTML += createContentLinks(studyMaterials.slides_lectures.current);
      }
      if (studyMaterials.slides_lectures.previous && studyMaterials.slides_lectures.previous.length > 0) {
        slidesHTML += createContentLinks(studyMaterials.slides_lectures.previous);
      }
      slidesContent.innerHTML = slidesHTML || 'No slide materials available yet.';
    }
    
    // Books and Manuals
    const booksContent = document.getElementById('books-content');
    if (booksContent && studyMaterials.books_manuals) {
      let booksHTML = '';
      if (studyMaterials.books_manuals.current) {
        booksHTML += createContentLinks(studyMaterials.books_manuals.current);
      }
      if (studyMaterials.books_manuals.previous && studyMaterials.books_manuals.previous.length > 0) {
        booksHTML += createContentLinks(studyMaterials.books_manuals.previous);
      }
      booksContent.innerHTML = booksHTML || 'No books/manuals available yet.';
    }
    
    // Previous Materials
    const previousContent = document.getElementById('previous-materials-content');
    if (previousContent && studyMaterials.previous_materials) {
      previousContent.innerHTML = createContentLinks(studyMaterials.previous_materials.links);
    }
    
    // Questions sections - Only Current and Previous
    if (subjectData.questions) {
      const currentQuestionsContent = document.getElementById('current-questions-content');
      if (currentQuestionsContent && subjectData.questions.current_questions) {
        currentQuestionsContent.innerHTML = createContentLinks(subjectData.questions.current_questions);
      }
      
      const previousQuestionsContent = document.getElementById('previous-questions-content');
      if (previousQuestionsContent && subjectData.questions.previous_questions) {
        previousQuestionsContent.innerHTML = createContentLinks(subjectData.questions.previous_questions);
      }
    }
    
    // Update course details with current batch and teacher
    updateCourseDetails(subjectData);
  }

  function updateCourseDetails(subjectData) {
    const courseInfoGrid = document.querySelector('.course-info-grid');
    if (courseInfoGrid && subjectData) {
      courseInfoGrid.innerHTML = `
        <div class="info-card">
          <h4>Course Code:</h4>
          <p>${subjectData.code}</p>
        </div>
        <div class="info-card">
          <h4>Course Title:</h4>
          <p>${subjectData.title}</p>
        </div>
        <div class="info-card">
          <h4>Current Batch:</h4>
          <p>${subjectData.current_batch || 'To be announced'}</p>
        </div>
        <div class="info-card">
          <h4>Current Teacher:</h4>
          <p>${subjectData.current_teacher || 'To be announced'}</p>
        </div>
      `;
    }
  }

  function createContentLinks(links) {
    if (!links || links.length === 0) return 'No content available yet.';
    
    return links.map(link => {
      if (link.folderId) {
        return createDriveLink(link.folderId, link.label);
      } else if (link.url) {
        return createDocumentLink(link.url, link.label);
      } else {
        return `<div class="placeholder-link">${link.label} (Coming soon)</div>`;
      }
    }).join('<br>');
  }

  function createDocumentLink(url, label) {
    if (!url) {
      return `<div class="placeholder-link">${label} (Coming soon)</div>`;
    }
    return `<a href="${url}" target="_blank" rel="noopener" class="drive-link">
      <span class="drive-icon">üìÑ</span>
      ${label}
    </a>`;
  }

  function createDriveLink(folderId, label) {
    return `<a href="https://drive.google.com/drive/folders/${folderId}" target="_blank" rel="noopener" class="drive-link">
      <span class="drive-icon">üìÅ</span>
      ${label}
    </a>`;
  }
  
  function updateBreadcrumb(config) {
    const breadcrumb = document.querySelector('.breadcrumb');
    if (breadcrumb) {
      breadcrumb.innerHTML = `
        <a href="../../index.html">Home</a> >
        <a href="../${config.semesterPage}">${config.semesterName}</a> >
        <span>${config.title}</span>
      `;
    }
  }
  
  function updatePageHeader(config) {
    const pageTitle = document.querySelector('.page-title');
    const pageDescription = document.querySelector('.page-description');
    const quickActions = document.querySelector('.quick-actions');
    
    if (pageTitle) {
      pageTitle.textContent = `${config.title} (${config.code})`;
    }
    
    if (pageDescription) {
      pageDescription.innerHTML = `<b>${config.description}</b>`;
    }
    
    if (quickActions) {
      quickActions.innerHTML = `
        <a href="../course-teachers.html?course=${config.code}" class="action-btn">
          <span class="icon">Teachers</span>
          View Teachers
        </a>
        <a href="../browse.html?search=${config.code}" class="action-btn">
          <span class="icon">Search</span>
          Search Resources
        </a>
        <a href="../${config.semesterPage}" class="action-btn">
          <span class="icon">Back</span>
          All ${config.semesterName}
        </a>
      `;
    }
  }
  
  function createStandardizedSections(config) {
    const container = document.querySelector('.subject-content');
    if (!container) return;
    
    container.innerHTML = `
      <!-- Course Overview -->
      <section class="card collapsible-section" id="overview">
        <div class="section-header" onclick="toggleSection('overview')">
          <h2>Course Overview</h2>
          <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="section-content">
          <div class="course-info-grid">
            <div class="info-card">
              <h4>Course Code:</h4>
              <p>${config.code}</p>
            </div>
            <div class="info-card">
              <h4>Course Title:</h4>
              <p>${config.title}</p>
            </div>
          </div>
          <div class="course-description">
            <p>${config.description}</p>
          </div>
        </div>
      </section>

      <!-- Study Materials Section -->
      <section class="card collapsible-section" id="study">
        <div class="section-header" onclick="toggleSection('study')">
          <h2>Study Materials</h2>
          <span class="toggle-icon">‚ñ≤</span>
        </div>
        <div class="section-content">
          <div class="subsection collapsible-subsection" id="class-updates">
            <div class="subsection-header" onclick="toggleSubsection('class-updates')">
              <h3>Class Updates</h3>
              <span class="toggle-icon">‚ñ≤</span>
            </div>
            <div class="subsection-content">
              <p>Latest class updates and announcements</p>
              <div class="resource-placeholder" id="class-updates-content">Loading content...</div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="personal-notes">
            <div class="subsection-header" onclick="toggleSubsection('personal-notes')">
              <h3>Personal Notes</h3>
              <span class="toggle-icon">‚ñ≤</span>
            </div>
            <div class="subsection-content">
              <p>Student-created study notes and summaries</p>
              <div class="resource-placeholder" id="personal-notes-content">Loading content...</div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="slides-lectures">
            <div class="subsection-header" onclick="toggleSubsection('slides-lectures')">
              <h3>Slides and Lecture Materials</h3>
              <span class="toggle-icon">‚ñ≤</span>
            </div>
            <div class="subsection-content">
              <p>Official lecture slides and presentation materials</p>
              <div class="resource-placeholder" id="slides-content">Loading content...</div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="books-manuals">
            <div class="subsection-header" onclick="toggleSubsection('books-manuals')">
              <h3>Books and Manuals</h3>
              <span class="toggle-icon">‚ñ≤</span>
            </div>
            <div class="subsection-content">
              <p>Textbooks, reference materials, and official manuals</p>
              <div class="resource-placeholder" id="books-content">Loading content...</div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="previous-materials">
            <div class="subsection-header" onclick="toggleSubsection('previous-materials')">
              <h3>Previous Materials</h3>
              <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="subsection-content">
              <p>Materials from previous batches and semesters</p>
              <div class="resource-placeholder" id="previous-materials-content">Loading content...</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Questions Section -->
      <section class="card collapsible-section" id="questions">
        <div class="section-header" onclick="toggleSection('questions')">
          <h2>Questions & Examinations</h2>
          <span class="toggle-icon">‚ñ≤</span>
        </div>
        <div class="section-content">
          <div class="subsection collapsible-subsection" id="current-questions">
            <div class="subsection-header" onclick="toggleSubsection('current-questions')">
              <h3>Current Questions</h3>
              <span class="toggle-icon">‚ñ≤</span>
            </div>
            <div class="subsection-content">
              <div class="resource-placeholder" id="current-questions-content">Loading content...</div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="previous-questions">
            <div class="subsection-header" onclick="toggleSubsection('previous-questions')">
              <h3>Previous Questions</h3>
              <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="subsection-content">
              <div class="resource-placeholder" id="previous-questions-content">Loading content...</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Previous Teachers Section -->
      <section class="card collapsible-section" id="previous-teachers">
        <div class="section-header" onclick="toggleSection('previous-teachers')">
          <h2>Previous Teachers</h2>
          <span class="toggle-icon">‚ñ≤</span>
        </div>
        <div class="section-content">
          <div class="teachers-list" id="previous-teachers-content">
            Loading previous teachers information...
          </div>
        </div>
      </section>
    `;
  }
  
  function initializeCollapsibleSections() {
    try {
      // Main sections: Course Overview, Study Materials, Questions, and Previous Teachers all expanded
      const sections = document.querySelectorAll('.collapsible-section');
      sections.forEach(section => {
        const content = section.querySelector('.section-content');
        const icon = section.querySelector('.toggle-icon');
        
        if (content && icon) {
          content.style.display = 'block';
          icon.textContent = '‚ñ≤';
        }
      });
      
      // Subsections: All expanded except "Previous" ones
      const subsections = document.querySelectorAll('.collapsible-subsection');
      subsections.forEach(subsection => {
        const content = subsection.querySelector('.subsection-content');
        const icon = subsection.querySelector('.toggle-icon');
        const isPreviousSection = subsection.id.includes('previous');
        
        if (content && icon) {
          if (isPreviousSection) {
            // Keep previous sections collapsed
            content.style.display = 'none';
            icon.textContent = '‚ñº';
          } else {
            // All other subsections expanded
            content.style.display = 'block';
            icon.textContent = '‚ñ≤';
          }
        }
      });
      
      // Load previous teachers
      loadPreviousTeachers();
    } catch (error) {
      console.error('Error initializing collapsible sections:', error);
    }
  }
  
  async function loadPreviousTeachers() {
    try {
      const response = await fetch('../../assets/faculty-mapping.json');
      if (!response.ok) {
        console.warn('Could not load faculty mapping');
        return;
      }
      
      const facultyData = await response.json();
      const config = window.subjectConfig;
      
      // Sample data - this would ideally come from a course-teacher mapping
      const previousTeachers = [
        { name: "Dr. Tahmina Khatun", batch: "29th Batch" },
        { name: "Dr. Yousuf Kamal", batch: "28th Batch" },
        { name: "Mamtaz Uddin Ahmed", batch: "27th Batch" }
      ];
      
      const previousTeachersContent = document.getElementById('previous-teachers-content');
      if (previousTeachersContent) {
        if (previousTeachers.length > 0) {
          const teachersHTML = previousTeachers.map(teacher => `
            <div class="teacher-item">
              <span class="teacher-name">${teacher.name}</span>
              <span class="teacher-batch">${teacher.batch}</span>
            </div>
          `).join('');
          previousTeachersContent.innerHTML = teachersHTML;
        } else {
          previousTeachersContent.innerHTML = '<p>No previous teacher information available.</p>';
        }
      }
    } catch (error) {
      console.error('Error loading previous teachers:', error);
      const previousTeachersContent = document.getElementById('previous-teachers-content');
      if (previousTeachersContent) {
        previousTeachersContent.innerHTML = '<p>Unable to load previous teachers information.</p>';
      }
    }
  }
  
  // Add CSS for drive links
  if (!document.querySelector('#drive-links-css')) {
    const styleElement = document.createElement('style');
    styleElement.id = 'drive-links-css';
    styleElement.textContent = `
      .drive-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border: 1px solid #dee2e6;
        border-radius: 6px;
        text-decoration: none;
        color: #495057;
        font-size: 14px;
        transition: all 0.2s ease;
        margin-bottom: 8px;
      }

      .drive-link:hover {
        background: linear-gradient(135deg, #e9ecef, #dee2e6);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }

      .drive-icon {
        font-size: 16px;
      }

      .placeholder-link {
        display: inline-block;
        padding: 8px 12px;
        background: #f8f9fa;
        border: 1px dashed #ced4da;
        border-radius: 6px;
        color: #6c757d;
        font-size: 14px;
        font-style: italic;
        margin-bottom: 8px;
      }

      .document-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        border: 1px solid #2196f3;
        border-radius: 8px;
        text-decoration: none;
        color: #1565c0;
        font-size: 15px;
        font-weight: 500;
        transition: all 0.2s ease;
        margin-bottom: 8px;
      }

      .document-link:hover {
        background: linear-gradient(135deg, #bbdefb, #90caf9);
        transform: translateY(-1px);
        box-shadow: 0 3px 6px rgba(33, 150, 243, 0.2);
      }

      .doc-icon {
        font-size: 18px;
      }

      .teacher-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        margin-bottom: 8px;
      }

      .teacher-name {
        font-weight: 500;
        color: #495057;
      }

      .teacher-batch {
        color: #6c757d;
        font-size: 14px;
      }
    `;
    document.head.appendChild(styleElement);
  }
  
  // Auto-initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeSubjectPage);
  } else {
    // DOM already loaded
    setTimeout(initializeSubjectPage, 100);
  }
</script>