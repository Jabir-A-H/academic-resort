<!-- Subject Page Template -->
<script src="../../assets/batch-loader.js"></script>
<script>
  // Global subject page functions
  window.toggleTOC = function () {
    try {
      const content = document.getElementById("table-of-contents");
      const toggle = document.getElementById("toc-toggle");
      if (content && toggle) {
        const isExpanded = content.style.display !== "none";
        content.style.display = isExpanded ? "none" : "block";
        toggle.textContent = isExpanded ? "‚ñº" : "‚ñ≤";
      }
    } catch (error) {
      console.error("Error in toggleTOC:", error);
    }
  };

  window.toggleSection = function (sectionId) {
    try {
      const section = document.getElementById(sectionId);
      if (!section) return;

      const content = section.querySelector(".section-content");
      const toggle = section.querySelector(".toggle-icon");

      if (content && toggle) {
        const isExpanded = content.style.display !== "none";
        content.style.display = isExpanded ? "none" : "block";
        toggle.textContent = isExpanded ? "‚ñº" : "‚ñ≤";
        section.classList.toggle("collapsed", isExpanded);
      }
    } catch (error) {
      console.error("Error in toggleSection:", error);
    }
  };

  window.toggleSubsection = function (subsectionId) {
    try {
      const subsection = document.getElementById(subsectionId);
      if (!subsection) return;

      const content = subsection.querySelector(".subsection-content");
      const toggle = subsection.querySelector(".toggle-icon");

      if (content && toggle) {
        const isExpanded = content.style.display !== "none";
        content.style.display = isExpanded ? "none" : "block";
        toggle.textContent = isExpanded ? "‚ñº" : "‚ñ≤";
        subsection.classList.toggle("collapsed", isExpanded);
      }
    } catch (error) {
      console.error("Error in toggleSubsection:", error);
    }
  };

  // Subject page configuration that will be set by each page
  window.subjectConfig = window.subjectConfig || {};

  function initializeSubjectPage() {
    try {
      const config = window.subjectConfig;
      if (!config) {
        console.error("Subject configuration not found");
        return;
      }

      // Update breadcrumb
      updateBreadcrumb(config);

      // Update page title and description
      updatePageHeader(config);

      // Create standardized sections
      createStandardizedSections(config);

      // Initialize collapsible sections
      initializeCollapsibleSections();

      // Load drive content
      loadDriveContent(config);

      console.log("Subject page initialized successfully for:", config.title);
    } catch (error) {
      console.error("Error initializing subject page:", error);
    }
  }

  async function loadDriveContent(config) {
    try {
      // Load subject data from consolidated batch files
      const subjectData = await getSubjectDataByCode(config.code);
      
      if (!subjectData) {
        console.warn("Could not load subject data for:", config.code);
        showPlaceholderContent();
        return;
      }

      // Populate sections with subject-specific drive links
      populateSubjectLinks(subjectData);
    } catch (error) {
      console.error("Error loading subject content:", error);
      showPlaceholderContent();
    }
  }

  function showPlaceholderContent() {
    // Show placeholder content when data loading fails
    const sections = [
      'class-updates-content',
      'personal-notes-content', 
      'slides-content',
      'books-content',
      'previous-materials-content',
      'current-questions-content',
      'previous-questions-content'
    ];
    
    sections.forEach(sectionId => {
      const element = document.getElementById(sectionId);
      if (element) {
        element.innerHTML = '<div class="placeholder-link">Content will be available soon</div>';
      }
    });
  }

  function populateSubjectLinks(subjectData) {
    if (!subjectData.links) return;

    const links = subjectData.links;

    // Class Updates - Simple document link
    const classUpdatesContent = document.getElementById(
      "class-updates-content"
    );
    if (classUpdatesContent && links.class_updates) {
      if (links.class_updates && links.class_updates !== "") {
        classUpdatesContent.innerHTML = `
          <a href="${links.class_updates}" target="_blank" rel="noopener" class="document-link">
            <span class="doc-icon">üìÑ</span>
            Latest Class Updates & Announcements
          </a>
        `;
      } else {
        classUpdatesContent.innerHTML = `
          <div class="placeholder-link">
            Latest Class Updates & Announcements (Coming soon)
          </div>
        `;
      }
    }

    // Personal Notes
    const personalNotesContent = document.getElementById(
      "personal-notes-content"
    );
    if (personalNotesContent && links.notes) {
      personalNotesContent.innerHTML =
        createLinksFromArray(links.notes) || "No notes available yet.";
    }

    // Slides and Lectures
    const slidesContent = document.getElementById("slides-content");
    if (slidesContent && links.slides_lectures) {
      slidesContent.innerHTML =
        createLinksFromArray(links.slides_lectures) ||
        "No slide materials available yet.";
    }

    // Books and Manuals
    const booksContent = document.getElementById("books-content");
    if (booksContent && links.books_manuals) {
      booksContent.innerHTML =
        createLinksFromArray(links.books_manuals) ||
        "No books/manuals available yet.";
    }

    // Previous Materials
    const previousContent = document.getElementById(
      "previous-materials-content"
    );
    if (previousContent && links.previous_materials) {
      previousContent.innerHTML =
        createLinksFromArray(links.previous_materials) ||
        "No previous materials available yet.";
    }

    // Current Questions (from question_papers field)
    const currentQuestionsContent = document.getElementById(
      "current-questions-content"
    );
    if (currentQuestionsContent && links.question_papers) {
      currentQuestionsContent.innerHTML =
        createLinksFromArray(links.question_papers) ||
        "No current questions available yet.";
    }

    // Previous Questions (from assignments field)
    const previousQuestionsContent = document.getElementById(
      "previous-questions-content"
    );
    if (previousQuestionsContent && links.assignments) {
      previousQuestionsContent.innerHTML =
        createLinksFromArray(links.assignments) ||
        "No previous questions available yet.";
    }

    // Update course details with current batch and teacher
    updateCourseDetails(subjectData);
  }

  function updateCourseDetails(subjectData) {
    const courseInfoGrid = document.querySelector(".course-info-grid");
    if (courseInfoGrid && subjectData) {
      // Show batch information if available
      const batchInfo = subjectData.batches && subjectData.batches.length > 0 
        ? subjectData.batches.map(b => b.batchName || `${b.batch}th Batch`).join(", ")
        : "Multiple batches";
        
      courseInfoGrid.innerHTML = `
        <div class="info-card">
          <h4>Course Code:</h4>
          <p>${subjectData.code}</p>
        </div>
        <div class="info-card">
          <h4>Course Title:</h4>
          <p>${subjectData.title}</p>
        </div>
        <div class="info-card">
          <h4>Available in Batches:</h4>
          <p>${batchInfo}</p>
        </div>
        <div class="info-card">
          <h4>Current Teacher:</h4>
          <p>${subjectData.current_teacher || "To be announced"}</p>
        </div>
      `;
    }
  }

  function createLinksFromArray(linkArray) {
    if (!linkArray || linkArray.length === 0) return "";

    return linkArray
      .map((url) => {
        if (!url || url === "")
          return '<div class="placeholder-link">Link coming soon</div>';

        // Parse the URL to determine type
        if (url.includes("docs.google.com/document")) {
          return createDocumentLink(url, "Document");
        } else if (url.includes("drive.google.com/drive/folders")) {
          // Extract folder ID from URL
          const match = url.match(/\/folders\/([a-zA-Z0-9_-]+)/);
          const folderId = match ? match[1] : null;
          if (folderId) {
            return createDriveLink(folderId, "Drive Folder");
          }
        } else if (url.includes("drive.google.com/file")) {
          return createDocumentLink(url, "Drive File");
        }

        // Fallback for other URLs
        return `<a href="${url}" target="_blank" rel="noopener" class="drive-link">
        <span class="drive-icon">üîó</span>
        Link
      </a>`;
      })
      .join("<br>");
  }

  function createContentLinks(links) {
    if (!links || links.length === 0) return "No content available yet.";

    return links
      .map((link) => {
        if (link.folderId) {
          return createDriveLink(link.folderId, link.label);
        } else if (link.url) {
          return createDocumentLink(link.url, link.label);
        } else {
          return `<div class="placeholder-link">${link.label} (Coming soon)</div>`;
        }
      })
      .join("<br>");
  }

  function createDocumentLink(url, label) {
    if (!url) {
      return `<div class="placeholder-link">${label} (Coming soon)</div>`;
    }
    return `<a href="${url}" target="_blank" rel="noopener" class="drive-link">
      <span class="drive-icon">üìÑ</span>
      ${label}
    </a>`;
  }

  function createDriveLink(folderId, label) {
    return `<a href="https://drive.google.com/drive/folders/${folderId}" target="_blank" rel="noopener" class="drive-link">
      <span class="drive-icon">üìÅ</span>
      ${label}
    </a>`;
  }

  function updateBreadcrumb(config) {
    const breadcrumb = document.querySelector(".breadcrumb");
    if (breadcrumb) {
      breadcrumb.innerHTML = `
        <a href="../../index.html">Home</a> >
        <a href="../${config.semesterPage}">${config.semesterName}</a> >
        <span>${config.title}</span>
      `;
    }
  }

  function updatePageHeader(config) {
    const pageTitle = document.querySelector(".page-title");
    const pageDescription = document.querySelector(".page-description");
    const quickActions = document.querySelector(".quick-actions");

    if (pageTitle) {
      pageTitle.textContent = `${config.title}`;
    }

    if (pageDescription) {
      pageDescription.innerHTML = `<span class="course-code">${config.code}</span> ${config.description}`;
    }

    if (quickActions) {
      quickActions.innerHTML = `
        <button onclick="window.location.href='../course-teachers.html?course=${config.code}'" class="google-btn secondary">
          <span class="btn-icon">üë®‚Äçüè´</span>
          View Teachers
        </button>
        <button onclick="window.location.href='../../index.html?search=${config.code}'" class="google-btn secondary">
          <span class="btn-icon">üîç</span>
          Search Resources
        </button>
        <button onclick="window.location.href='../${config.semesterPage}'" class="google-btn primary">
          <span class="btn-icon">‚Ü©Ô∏è</span>
          Back to ${config.semesterName}
        </button>
      `;
    }
  }

  function createStandardizedSections(config) {
    const container = document.querySelector(".subject-content");
    if (!container) return;

    container.innerHTML = `
      <!-- Course Overview -->
      <div class="google-card collapsible-section" id="overview">
        <div class="section-header" onclick="toggleSection('overview')">
          <h2 class="section-title">Course Overview</h2>
          <span class="toggle-icon google-toggle">‚ñº</span>
        </div>
        <div class="section-content">
          <div class="course-info-grid">
            <div class="info-card">
              <h4 class="info-label">Course Code</h4>
              <p class="info-value">${config.code}</p>
            </div>
            <div class="info-card">
              <h4 class="info-label">Course Title</h4>
              <p class="info-value">${config.title}</p>
            </div>
          </div>
          <div class="course-description">
            <p>${config.description}</p>
          </div>
        </div>
      </div>

      <!-- Study Materials Section -->
      <div class="google-card collapsible-section" id="study">
        <div class="section-header" onclick="toggleSection('study')">
          <h2 class="section-title">Study Materials</h2>
          <span class="toggle-icon google-toggle">‚ñ≤</span>
        </div>
        <div class="section-content">
          <div class="subsection collapsible-subsection" id="class-updates">
            <div class="subsection-header" onclick="toggleSubsection('class-updates')">
              <h3 class="subsection-title">üì¢ Class Updates</h3>
              <span class="toggle-icon google-toggle-small">‚ñ≤</span>
            </div>
            <div class="subsection-content">
              <div class="subsection-description">Latest class updates and announcements</div>
              <div class="resource-content" id="class-updates-content">
                <div class="loading-state">Loading content...</div>
              </div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="personal-notes">
            <div class="subsection-header" onclick="toggleSubsection('personal-notes')">
              <h3 class="subsection-title">üìù Personal Notes</h3>
              <span class="toggle-icon google-toggle-small">‚ñ≤</span>
            </div>
            <div class="subsection-content">
              <div class="subsection-description">Student-created study notes and summaries</div>
              <div class="resource-content" id="personal-notes-content">
                <div class="loading-state">Loading content...</div>
              </div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="slides-lectures">
            <div class="subsection-header" onclick="toggleSubsection('slides-lectures')">
              <h3 class="subsection-title">üìä Slides and Lecture Materials</h3>
              <span class="toggle-icon google-toggle-small">‚ñ≤</span>
            </div>
            <div class="subsection-content">
              <div class="subsection-description">Official lecture slides and presentation materials</div>
              <div class="resource-content" id="slides-content">
                <div class="loading-state">Loading content...</div>
              </div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="books-manuals">
            <div class="subsection-header" onclick="toggleSubsection('books-manuals')">
              <h3 class="subsection-title">üìö Books and Manuals</h3>
              <span class="toggle-icon google-toggle-small">‚ñ≤</span>
            </div>
            <div class="subsection-content">
              <div class="subsection-description">Textbooks, reference materials, and official manuals</div>
              <div class="resource-content" id="books-content">
                <div class="loading-state">Loading content...</div>
              </div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="previous-materials">
            <div class="subsection-header" onclick="toggleSubsection('previous-materials')">
              <h3 class="subsection-title">üìÅ Previous Materials</h3>
              <span class="toggle-icon google-toggle-small">‚ñº</span>
            </div>
            <div class="subsection-content">
              <div class="subsection-description">Materials from previous batches and semesters</div>
              <div class="resource-content" id="previous-materials-content">
                <div class="loading-state">Loading content...</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Questions Section -->
      <div class="google-card collapsible-section" id="questions">
        <div class="section-header" onclick="toggleSection('questions')">
          <h2 class="section-title">Questions & Examinations</h2>
          <span class="toggle-icon google-toggle">‚ñ≤</span>
        </div>
        <div class="section-content">
          <div class="subsection collapsible-subsection" id="current-questions">
          <div class="subsection collapsible-subsection" id="current-questions">
            <div class="subsection-header" onclick="toggleSubsection('current-questions')">
              <h3 class="subsection-title">üìù Current Questions</h3>
              <span class="toggle-icon google-toggle-small">‚ñ≤</span>
            </div>
            <div class="subsection-content">
              <div class="subsection-description">Recent exam questions and practice materials</div>
              <div class="resource-content" id="current-questions-content">
                <div class="loading-state">Loading content...</div>
              </div>
            </div>
          </div>
          
          <div class="subsection collapsible-subsection" id="previous-questions">
            <div class="subsection-header" onclick="toggleSubsection('previous-questions')">
              <h3 class="subsection-title">üìã Previous Questions</h3>
              <span class="toggle-icon google-toggle-small">‚ñº</span>
            </div>
            <div class="subsection-content">
              <div class="subsection-description">Historical exam questions and answer keys</div>
              <div class="resource-content" id="previous-questions-content">
                <div class="loading-state">Loading content...</div>
              </div>
            </div>
          </div>
        </div>
      </div>

    `;
  }

  function initializeCollapsibleSections() {
    try {
      // Main sections: Course Overview, Study Materials, Questions, and Previous Teachers all expanded
      const sections = document.querySelectorAll(".collapsible-section");
      sections.forEach((section) => {
        const content = section.querySelector(".section-content");
        const icon = section.querySelector(".toggle-icon");

        if (content && icon) {
          content.style.display = "block";
          icon.textContent = "‚ñ≤";
        }
      });

      // Subsections: All expanded except "Previous" ones
      const subsections = document.querySelectorAll(".collapsible-subsection");
      subsections.forEach((subsection) => {
        const content = subsection.querySelector(".subsection-content");
        const icon = subsection.querySelector(".toggle-icon");
        const isPreviousSection = subsection.id.includes("previous");

        if (content && icon) {
          if (isPreviousSection) {
            // Keep previous sections collapsed
            content.style.display = "none";
            icon.textContent = "‚ñº";
          } else {
            // All other subsections expanded
            content.style.display = "block";
            icon.textContent = "‚ñ≤";
          }
        }
      });
    } catch (error) {
      console.error("Error initializing collapsible sections:", error);
    }
  }

  // Add CSS for Google-style subject pages
  if (!document.querySelector("#google-subject-css")) {
    const styleElement = document.createElement("style");
    styleElement.id = "google-subject-css";
    styleElement.textContent = `
      /* Google-style Page Layout */
      .page-intro {
        background: transparent;
        padding: 20px 0;
        margin-bottom: 24px;
        text-align: center;
      }
      
      .page-title {
        font-size: 2.5rem;
        font-weight: 400;
        color: #202124;
        margin: 0 0 8px 0;
        line-height: 1.2;
      }
      
      .page-description {
        font-size: 16px;
        color: #5f6368;
        margin: 0 0 24px 0;
        line-height: 1.5;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
      }
      
      .course-code {
        display: inline-block;
        background: #1a73e8;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        margin-right: 8px;
      }

      /* Google-style Buttons */
      .quick-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
        flex-wrap: wrap;
        margin: 24px 0;
      }

      .google-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border: 1px solid #dadce0;
        border-radius: 4px;
        background: white;
        color: #3c4043;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        font-family: inherit;
        outline: none;
      }

      .google-btn:hover {
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
        border-color: #dadce0;
      }

      .google-btn.primary {
        background: #1a73e8;
        color: white;
        border-color: #1a73e8;
      }

      .google-btn.primary:hover {
        background: #1557b0;
        border-color: #1557b0;
      }

      .google-btn.secondary:hover {
        background: #f8f9fa;
      }

      .btn-icon {
        font-size: 16px;
      }

      /* Google-style Cards */
      .google-card {
        background: white;
        border: 1px solid #dadce0;
        border-radius: 8px;
        margin-bottom: 16px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        transition: box-shadow 0.2s ease;
      }

      .google-card:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      /* Section Headers */
      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        background: #f8f9fa;
        border-bottom: 1px solid #dadce0;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      .section-header:hover {
        background: #f1f3f4;
      }

      .section-title {
        font-size: 18px;
        font-weight: 500;
        color: #202124;
        margin: 0;
      }

      .google-toggle {
        font-size: 14px;
        color: #5f6368;
        transition: transform 0.2s ease;
        font-weight: bold;
      }

      .section-content {
        padding: 20px;
      }

      /* Subsections */
      .subsection {
        margin-bottom: 20px;
        border: 1px solid #e8eaed;
        border-radius: 6px;
        overflow: hidden;
      }

      .subsection:last-child {
        margin-bottom: 0;
      }

      .subsection-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: #fafbfc;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      .subsection-header:hover {
        background: #f1f3f4;
      }

      .subsection-title {
        font-size: 15px;
        font-weight: 500;
        color: #202124;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .google-toggle-small {
        font-size: 12px;
        color: #5f6368;
        transition: transform 0.2s ease;
        font-weight: bold;
      }

      .subsection-content {
        padding: 16px;
        background: white;
      }

      .subsection-description {
        font-size: 14px;
        color: #5f6368;
        margin-bottom: 12px;
        line-height: 1.4;
      }

      .resource-content {
        min-height: 40px;
      }

      .loading-state {
        color: #5f6368;
        font-style: italic;
        font-size: 14px;
        padding: 8px 0;
      }

      /* Course Info Grid */
      .course-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 20px;
      }

      .info-card {
        padding: 16px;
        background: #f8f9fa;
        border-radius: 6px;
        border: 1px solid #e8eaed;
      }

      .info-label {
        font-size: 14px;
        font-weight: 500;
        color: #5f6368;
        margin: 0 0 8px 0;
      }

      .info-value {
        font-size: 16px;
        font-weight: 400;
        color: #202124;
        margin: 0;
      }

      .course-description {
        padding: 16px;
        background: #f8f9fa;
        border-radius: 6px;
        font-size: 14px;
        line-height: 1.5;
        color: #3c4043;
      }

      /* Drive Links */
      .drive-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: white;
        border: 1px solid #dadce0;
        border-radius: 6px;
        text-decoration: none;
        color: #1a73e8;
        font-size: 14px;
        transition: all 0.2s ease;
        margin: 4px 8px 4px 0;
        font-weight: 500;
      }

      .drive-link:hover {
        background: #f8f9fa;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
        text-decoration: none;
        color: #1557b0;
      }

      .drive-icon {
        font-size: 16px;
      }

      .document-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        background: #e8f0fe;
        border: 1px solid #1a73e8;
        border-radius: 6px;
        text-decoration: none;
        color: #1a73e8;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        margin: 4px 8px 4px 0;
      }

      .document-link:hover {
        background: #d2e3fc;
        text-decoration: none;
        color: #1557b0;
        box-shadow: 0 1px 3px rgba(26, 115, 232, 0.2);
      }

      .doc-icon {
        font-size: 18px;
      }

      .placeholder-link {
        display: inline-block;
        padding: 8px 12px;
        background: #f8f9fa;
        border: 1px dashed #dadce0;
        border-radius: 6px;
        color: #5f6368;
        font-size: 14px;
        font-style: italic;
        margin: 4px 8px 4px 0;
      }

      /* Breadcrumb */
      .breadcrumb {
        font-size: 14px;
        color: #5f6368;
        margin-bottom: 16px;
        padding: 0 20px;
      }

      .breadcrumb a {
        color: #1a73e8;
        text-decoration: none;
      }

      .breadcrumb a:hover {
        text-decoration: underline;
      }

      /* Table of Contents */
      .toc-accordion {
        margin: 20px auto;
        max-width: 600px;
        background: white;
        border: 1px solid #dadce0;
        border-radius: 6px;
        overflow: hidden;
      }

      .toc-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: #f8f9fa;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      .toc-header:hover {
        background: #f1f3f4;
      }

      .toc-content {
        padding: 16px;
        list-style: none;
        margin: 0;
      }

      .toc-content li {
        margin-bottom: 8px;
      }

      .toc-content a {
        color: #1a73e8;
        text-decoration: none;
        font-size: 14px;
      }

      .toc-content a:hover {
        text-decoration: underline;
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .page-title {
          font-size: 2rem;
        }

        .quick-actions {
          flex-direction: column;
          align-items: center;
        }

        .google-btn {
          width: 100%;
          max-width: 300px;
          justify-content: center;
        }

        .course-info-grid {
          grid-template-columns: 1fr;
        }

        .section-content {
          padding: 16px;
        }

        .subsection-content {
          padding: 12px;
        }

        .breadcrumb {
          padding: 0 16px;
        }
      }

    `;
    document.head.appendChild(styleElement);
  }

  // Auto-initialize when DOM is ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initializeSubjectPage);
  } else {
    // DOM already loaded
    setTimeout(initializeSubjectPage, 100);
  }
</script>
